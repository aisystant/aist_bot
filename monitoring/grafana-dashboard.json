{
  "__inputs": [
    {
      "name": "DS_NEON",
      "label": "Neon Bot DB",
      "description": "PostgreSQL datasource pointing to Neon (aist bot DB)",
      "type": "datasource",
      "pluginId": "grafana-postgresql-datasource",
      "pluginName": "PostgreSQL"
    }
  ],
  "__requires": [
    {"type": "grafana", "id": "grafana", "name": "Grafana", "version": "10.0.0"},
    {"type": "datasource", "id": "grafana-postgresql-datasource", "name": "PostgreSQL"}
  ],
  "title": "Aist Bot: Error Monitoring",
  "uid": "aist-bot-errors",
  "description": "Error classification (DP.RUNBOOK.001), severity distribution, L4 escalation tracking. WP-45.",
  "tags": ["aist-bot", "observability", "wp-45"],
  "timezone": "Europe/Moscow",
  "refresh": "5m",
  "time": {"from": "now-24h", "to": "now"},
  "panels": [
    {
      "id": 1,
      "type": "stat",
      "title": "Errors (24h)",
      "gridPos": {"h": 4, "w": 4, "x": 0, "y": 0},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT SUM(occurrence_count)::bigint AS value FROM error_logs WHERE last_seen_at > NOW() - INTERVAL '24 hours'",
        "format": "table",
        "refId": "A"
      }],
      "options": {"colorMode": "background", "graphMode": "none"},
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {"color": "green", "value": null},
              {"color": "yellow", "value": 10},
              {"color": "red", "value": 50}
            ]
          }
        }
      }
    },
    {
      "id": 2,
      "type": "stat",
      "title": "L3+ Errors",
      "gridPos": {"h": 4, "w": 4, "x": 4, "y": 0},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT COUNT(*) AS value FROM error_logs WHERE last_seen_at > NOW() - INTERVAL '24 hours' AND severity IN ('L3', 'L4')",
        "format": "table",
        "refId": "A"
      }],
      "options": {"colorMode": "background", "graphMode": "none"},
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {"color": "green", "value": null},
              {"color": "orange", "value": 1},
              {"color": "red", "value": 3}
            ]
          }
        }
      }
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Unknown Errors",
      "gridPos": {"h": 4, "w": 4, "x": 8, "y": 0},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT COUNT(*) AS value FROM error_logs WHERE last_seen_at > NOW() - INTERVAL '24 hours' AND category = 'unknown'",
        "format": "table",
        "refId": "A"
      }],
      "options": {"colorMode": "background", "graphMode": "none"},
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {"color": "green", "value": null},
              {"color": "yellow", "value": 1},
              {"color": "red", "value": 5}
            ]
          }
        }
      }
    },
    {
      "id": 4,
      "type": "stat",
      "title": "Unique Errors (24h)",
      "gridPos": {"h": 4, "w": 4, "x": 12, "y": 0},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT COUNT(DISTINCT error_key) AS value FROM error_logs WHERE last_seen_at > NOW() - INTERVAL '24 hours'",
        "format": "table",
        "refId": "A"
      }],
      "options": {"colorMode": "background", "graphMode": "none"},
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {"color": "green", "value": null},
              {"color": "yellow", "value": 5},
              {"color": "red", "value": 20}
            ]
          }
        }
      }
    },
    {
      "id": 5,
      "type": "stat",
      "title": "L1 Recoveries (24h)",
      "description": "Users auto-recovered by unstick.py",
      "gridPos": {"h": 4, "w": 4, "x": 16, "y": 0},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT SUM(occurrence_count)::bigint AS value FROM error_logs WHERE last_seen_at > NOW() - INTERVAL '24 hours' AND logger_name = 'core.unstick' AND message LIKE '%Recovered%'",
        "format": "table",
        "refId": "A"
      }],
      "options": {"colorMode": "background", "graphMode": "none"},
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              {"color": "blue", "value": null},
              {"color": "green", "value": 1}
            ]
          }
        }
      }
    },
    {
      "id": 10,
      "type": "timeseries",
      "title": "Error Rate by Category",
      "gridPos": {"h": 8, "w": 16, "x": 0, "y": 4},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT $__timeGroup(last_seen_at, '1h') AS time, COALESCE(category, 'unclassified') AS category, SUM(occurrence_count)::float AS total FROM error_logs WHERE $__timeFilter(last_seen_at) AND category IS NOT NULL GROUP BY 1, 2 ORDER BY 1",
        "format": "time_series",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "custom": {"fillOpacity": 20, "stacking": {"mode": "normal"}}
        }
      }
    },
    {
      "id": 11,
      "type": "piechart",
      "title": "Severity Distribution",
      "gridPos": {"h": 8, "w": 8, "x": 16, "y": 4},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT COALESCE(severity, 'unclassified') AS severity, COUNT(*)::bigint AS count FROM error_logs WHERE last_seen_at > NOW() - INTERVAL '24 hours' GROUP BY 1",
        "format": "table",
        "refId": "A"
      }],
      "options": {"legend": {"displayMode": "table", "placement": "right"}},
      "fieldConfig": {
        "overrides": [
          {"matcher": {"id": "byName", "options": "L1"}, "properties": [{"id": "color", "value": {"fixedColor": "green", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "L2"}, "properties": [{"id": "color", "value": {"fixedColor": "yellow", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "L3"}, "properties": [{"id": "color", "value": {"fixedColor": "orange", "mode": "fixed"}}]},
          {"matcher": {"id": "byName", "options": "L4"}, "properties": [{"id": "color", "value": {"fixedColor": "red", "mode": "fixed"}}]}
        ]
      }
    },
    {
      "id": 20,
      "type": "table",
      "title": "Recent Classified Errors",
      "gridPos": {"h": 10, "w": 24, "x": 0, "y": 12},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT severity, category, logger_name, LEFT(message, 120) AS message, suggested_action, occurrence_count, context->>'user_id' AS user_id, last_seen_at FROM error_logs WHERE last_seen_at > NOW() - INTERVAL '24 hours' AND category IS NOT NULL ORDER BY CASE severity WHEN 'L4' THEN 1 WHEN 'L3' THEN 2 WHEN 'L2' THEN 3 ELSE 4 END, last_seen_at DESC LIMIT 30",
        "format": "table",
        "refId": "A"
      }],
      "options": {"sortBy": [{"displayName": "last_seen_at", "desc": true}]}
    },
    {
      "id": 21,
      "type": "table",
      "title": "Unknown Errors (Triage)",
      "description": "Errors not matching any RUNBOOK pattern â€” candidates for new patterns",
      "gridPos": {"h": 8, "w": 24, "x": 0, "y": 22},
      "targets": [{
        "datasource": {"uid": "${DS_NEON}", "type": "grafana-postgresql-datasource"},
        "rawSql": "SELECT logger_name, LEFT(message, 200) AS message, occurrence_count, first_seen_at, last_seen_at FROM error_logs WHERE category = 'unknown' AND last_seen_at > NOW() - INTERVAL '7 days' ORDER BY occurrence_count DESC LIMIT 20",
        "format": "table",
        "refId": "A"
      }],
      "options": {"sortBy": [{"displayName": "occurrence_count", "desc": true}]}
    }
  ],
  "schemaVersion": 39,
  "version": 1
}
