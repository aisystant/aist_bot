# CLAUDE.md ‚Äî AIST Track Bot (new-architecture)

> **–û–±—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** —Å–º. `/Users/tserentserenov/Github/CLAUDE.md`
>
> –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –¥–∞–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

---

## 1. –¢–∏–ø —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

**Downstream-instrument** ‚Äî Telegram-–±–æ—Ç –º–∞—Ä–∞—Ñ–æ–Ω–∞ –ª–∏—á–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.

**–ù–ï —è–≤–ª—è–µ—Ç—Å—è source-of-truth** ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ Pack'–∞—Ö.

**–í–µ—Ç–∫–∏:** `pilot` (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞) ‚Üí `new-architecture` (–ø—Ä–æ–¥). –ü—Ä–∞–≤–∏–ª–æ Pilot-First ‚Äî —Å–º. MEMORY.md.

---

## 2. –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è

**–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ [ontology.md](ontology.md).**

### 2.1. –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞

| –¢–µ—Ä–º–∏–Ω | –ß—Ç–æ —ç—Ç–æ |
|--------|---------|
| **–£—á–µ–Ω–∏–∫** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ú–∞—Ä–∞—Ñ–æ–Ω–∞ |
| **–ß–∏—Ç–∞—Ç–µ–ª—å** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –õ–µ–Ω—Ç—ã |
| **–ú–∞—Ä–∞—Ñ–æ–Ω** | 14-–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ |
| **–õ–µ–Ω—Ç–∞** | –ì–∏–±–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–æ –¥–∞–π–¥–∂–µ—Å—Ç–∞–º |
| **–£—Ä–æ–∫** | –¢–µ–æ—Ä–∏—è –≤ –ú–∞—Ä–∞—Ñ–æ–Ω–µ |
| **–ó–∞–¥–∞–Ω–∏–µ** | –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤ –ú–∞—Ä–∞—Ñ–æ–Ω–µ |
| **–î–∞–π–¥–∂–µ—Å—Ç** | –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –≤ –õ–µ–Ω—Ç–µ |
| **–§–∏–∫—Å–∞—Ü–∏—è** | –õ–∏—á–Ω—ã–π –≤—ã–≤–æ–¥ –ß–∏—Ç–∞—Ç–µ–ª—è |

### 2.2. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–¥–∞ –∏ —Ç–µ—Ä–º–∏–Ω–æ–≤

| –¢–µ—Ä–º–∏–Ω | –í –∫–æ–¥–µ —Å–µ–π—á–∞—Å | –¶–µ–ª–µ–≤–æ–µ –∏–º—è |
|--------|---------------|-------------|
| –£—Ä–æ–∫ | `theory` | `lesson` |
| –ó–∞–¥–∞–Ω–∏–µ | `practice` | `task` |
| –î–∞–π–¥–∂–µ—Å—Ç | `feed_session` | `digest` |

---

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

```
aist_bot/
‚îú‚îÄ‚îÄ bot.py                    # –¢–æ–Ω–∫–∏–π –∫–ª–∏–µ–Ω—Ç (~246 —Å—Ç—Ä–æ–∫): config + imports + main()
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ machine.py            # –î–≤–∏–∂–æ–∫ State Machine (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ dispatcher.py         # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ (mode-aware /learn)
‚îÇ   ‚îú‚îÄ‚îÄ topics.py             # –î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ç–µ–º: TOPICS, get_marathon_day, save_answer
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py          # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ storage.py            # PostgresStorage (FSM persistence)
‚îÇ   ‚îú‚îÄ‚îÄ middleware.py          # LoggingMiddleware
‚îÇ   ‚îú‚îÄ‚îÄ helpers.py            # MODE_STATE_MAP, get_user_mode_state
‚îÇ   ‚îú‚îÄ‚îÄ intent.py             # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ knowledge.py          # –ü–æ–∏—Å–∫ –ø–æ MCP
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py           # setup_handlers(dp, dispatcher), setup_fallback(dp)
‚îÇ   ‚îú‚îÄ‚îÄ commands.py           # –¢–æ–Ω–∫–∏–µ –æ–±—ë—Ä—Ç–∫–∏: /learn, /feed, /mode ‚Üí dispatcher
‚îÇ   ‚îú‚îÄ‚îÄ callbacks.py          # Callback queries ‚Üí dispatcher
‚îÇ   ‚îú‚îÄ‚îÄ onboarding.py         # /start + OnboardingStates
‚îÇ   ‚îú‚îÄ‚îÄ settings.py           # /profile, /help, /update, /language + UpdateStates
‚îÇ   ‚îú‚îÄ‚îÄ progress.py           # /progress + full report
‚îÇ   ‚îú‚îÄ‚îÄ linear.py             # /linear –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ twin.py               # /twin —Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–≤–æ–π–Ω–∏–∫
‚îÇ   ‚îî‚îÄ‚îÄ fallback.py           # Catch-all: SM routing
‚îú‚îÄ‚îÄ states/                   # State Machine —Å—Ç–µ–π—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ common/               # start, mode_select, settings
‚îÇ   ‚îú‚îÄ‚îÄ workshops/marathon/   # lesson, question, bonus, task
‚îÇ   ‚îú‚îÄ‚îÄ feed/                 # topics, digest
‚îÇ   ‚îî‚îÄ‚îÄ utilities/            # progress
‚îú‚îÄ‚îÄ engines/                  # –†–µ–∂–∏–º—ã (mode_selector, feed)
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ settings.py           # –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ transitions.yaml      # –¢–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ SM
‚îú‚îÄ‚îÄ clients/                  # Claude API, MCP –∫–ª–∏–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ db/                       # PostgreSQL queries
‚îú‚îÄ‚îÄ i18n/                     # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ integrations/telegram/    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îî‚îÄ‚îÄ docs/                     # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

### 3.1. –ü—Ä–∞–≤–∏–ª–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ü–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤ (–∫—Ä–∏—Ç–∏—á–Ω–æ!):** engines ‚Üí handlers ‚Üí fallback –ü–û–°–õ–ï–î–ù–ò–ú.

**–ò–º–ø–æ—Ä—Ç—ã ‚Äî –æ—Ç–∫—É–¥–∞ —á—Ç–æ –±—Ä–∞—Ç—å:**

| –ß—Ç–æ –Ω—É–∂–Ω–æ | –û—Ç–∫—É–¥–∞ | –ù–ï –∏–∑ |
|-----------|--------|-------|
| –î–æ–º–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (get_marathon_day, TOPICS, save_answer) | `core.topics` | ~~bot~~ |
| –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (BLOOM_AUTO_UPGRADE_AFTER, STUDY_DURATIONS) | `config` | ~~bot~~ |
| –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (kb_update_profile) | `integrations.telegram.keyboards` | ~~bot~~ |
| FSM —Å—Ç–µ–π—Ç—ã (UpdateStates) | `handlers.settings` | ~~bot~~ |
| `claude`, `state_machine` | `bot` | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ bot.py |

**Lazy imports (`_bot_imports()`)** ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ handlers/ –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞ circular dependencies. –í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π, –Ω–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è.

**bot.py ‚Äî re-exports:** bot.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å—ë –∏–∑ core/topics, handlers/ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –ù–æ–≤—ã–π –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–∞–ø—Ä—è–º—É—é.

---

## 4. –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û–ø–∏—Å—ã–≤–∞–µ—Ç | –ü–∞–ø–∫–∞ |
|-----------|-----------|-------|
| **–°—Ü–µ–Ω–∞—Ä–∏–π** | –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–æ—Ç–æ–º | `docs/scenarios/` |
| **–ü—Ä–æ—Ü–µ—Å—Å** | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ | `docs/processes/` |
| **–î–∞–Ω–Ω—ã–µ** | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î | `docs/data/` |

---

## 5. –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 5.1. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ ‚Äî –°–ü–†–û–°–ò

**–õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç:**
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–°—Ü–µ–Ω–∞—Ä–∏–π/–ü—Ä–æ—Ü–µ—Å—Å/–î–∞–Ω–Ω—ã–µ)
2. –°–ø—Ä–æ—Å–∏—Ç—å: "–≠—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞—Ç—Ä–æ–Ω–µ—Ç [–∫–∞—Ç–µ–≥–æ—Ä–∏—è]. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ?"
3. –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. –ö–æ–¥ + –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –æ–¥–Ω–æ–º –∫–æ–º–º–∏—Ç–µ

### 5.2. README.md

–ò–∑–º–µ–Ω—è—Ç—å **—Ç–æ–ª—å–∫–æ —Å —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.

---

## 6. –†–∞–±–æ—Ç–∞ —Å –≤–µ—Ç–∫–∞–º–∏

| –í–µ—Ç–∫–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------|
| `main` | Production |
| `new-architecture` | State Machine (—ç—Ç–∞ –≤–µ—Ç–∫–∞) |

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å main

- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞—Ç—å `rebase` –Ω–∞ main
- –ù–µ –º–µ—Ä–∂–∏—Ç—å –≤ main –¥–æ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∑–∞ feature flags

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –º–µ—Ä–∂—É

- [ ] –í—Å–µ —Å—Ç–µ–π—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Feature flag —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Smoke test –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] E2E —Ç–µ—Å—Ç—ã –≤ Telegram –ø—Ä–æ–π–¥–µ–Ω—ã

---

## 7. –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

### –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è
- [ ] –¢–µ—Ä–º–∏–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç `ontology.md`
- [ ] –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- [ ] –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–º–µ–Ω–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è
- [ ] –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

---

## 8. State Machine ‚Äî –ø—Ä–∞–≤–∏–ª–∞

- **enter()** –î–û–õ–ñ–ï–ù –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É-—Å–æ–±—ã—Ç–∏–µ –≤–æ –í–°–ï–• –≤–µ—Ç–∫–∞—Ö –≤—ã—Ö–æ–¥–∞. `return` –±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏—è = —Å—Ç–µ–π—Ç –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç.
- –ö–∞–∂–¥–æ–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ —Å–æ–±—ã—Ç–∏–µ –î–û–õ–ñ–ù–û –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ `config/transitions.yaml`.
- **handle()** –ù–ï –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –ª—é–±–æ–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—è–π –æ–∂–∏–¥–∞–µ–º—ã–π –≤–≤–æ–¥.
- **go_to() silent return:** –ø—Ä–æ–≤–µ—Ä—è–π —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–π `context`, –Ω–µ `full_context` (—Å exit_context). –ò–Ω–∞—á–µ exit() –º–æ–¥–∞–ª—å–Ω–æ–≥–æ —Å—Ç–µ–π—Ç–∞ (consultation_complete) –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã (/learn –∏ –¥—Ä.) –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ —Å—Ç–µ–π—Ç–∞.
- **go_to() + _previous:** –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –º–æ–¥–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç —á–µ—Ä–µ–∑ go_to() ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π previous_state. –ò–Ω–∞—á–µ _previous –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ callback-–≤—ã–∑–æ–≤–∞ (‚úèÔ∏è/üîç) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

---

## 9. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

| –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ |
|-------------|-----------|
| "–∫–æ–Ω—Ç–µ–Ω—Ç" (–≤ –õ–µ–Ω—Ç–µ) | –î–∞–π–¥–∂–µ—Å—Ç |
| "—Ç–µ–º–∞" | –£—Ä–æ–∫ / –ó–∞–¥–∞–Ω–∏–µ / –î–∞–π–¥–∂–µ—Å—Ç |
| "—Å–µ—Å—Å–∏—è" | –î–∞–π–¥–∂–µ—Å—Ç / –î–µ–Ω—å |
| "—Ä–µ—Ñ–ª–µ–∫—Å–∏—è" | –§–∏–∫—Å–∞—Ü–∏—è |
| "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" | –£—á–µ–Ω–∏–∫ / –ß–∏—Ç–∞—Ç–µ–ª—å |

### Anti-hallucination –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞

1. **–ì—Ä–∞–Ω–∏—Ü–∞ –∑–Ω–∞–Ω–∏–π = –ø—Ä–∞–≤–∏–ª–æ #1** (question_handler.py). –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ¬´–ù–ï –¥–æ–¥—É–º—ã–≤–∞–π¬ª –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–≤–æ–π, –Ω–µ —Ç—Ä–µ—Ç—å–µ–π ‚Äî –∏–Ω–∞—á–µ –∫–æ–Ω–∫—É—Ä–∏—Ä—É–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏.
2. **Depth instruction ‚Üí ¬´–∏—Å–ø–æ–ª—å–∑—É–π –í–°–ï –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞¬ª**, –∞ –ù–ï ¬´–æ–±—ä—è—Å–Ω–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã, –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã¬ª ‚Äî –≤—Ç–æ—Ä–æ–µ –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏.
3. **Structured data > MCP** –¥–ª—è —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: `previous_days_connection` –∏–∑ topic YAML ‚Üí `format_structured_context()` ‚Üí –º–æ–¥–µ–ª—å –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–µ—Ç —Å–≤—è–∑–∏.

---

## 10. –õ–æ–≤—É—à–∫–∏ i18n –∏ UI

### 10.1. Markdown-–∫—Ä–∞—à –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–∞

`t()` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∫–ª—é—á–∞ (–Ω–∞–ø—Ä. `"help.about_marathon"`).
–ï—Å–ª–∏ –≤ –Ω–µ–π `_` ‚Äî Telegram –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ –∫—É—Ä—Å–∏–≤ ‚Üí `TelegramBadRequest: can't parse entities`.

**–ü—Ä–∞–≤–∏–ª–æ:** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ `t()` –≤—ã–∑–æ–≤–∞ ‚Äî —É–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–ª—é—á —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ schema.yaml + es.yaml + fr.yaml.

### 10.2. Markdown fallback –¥–ª—è Claude-–∫–æ–Ω—Ç–µ–Ω—Ç–∞

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ LLM-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å `parse_mode="Markdown"` ‚Äî **–≤—Å–µ–≥–¥–∞** –æ–±–æ—Ä–∞—á–∏–≤–∞–π –≤ `try/except` —Å fallback –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. Claude –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (`*`, `_`, `[`), –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–º–∞—é—Ç Telegram API (`TelegramBadRequest: can't parse entities`).

### 10.3. State –Ω–µ –¥–æ–ª–∂–µ–Ω –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å DB-—É–∫–∞–∑–∞—Ç–µ–ª—å —á—É–∂–æ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

Lesson state (theory) **–Ω–µ –¥–æ–ª–∂–µ–Ω** –º–µ–Ω—è—Ç—å `current_topic_index` –≤ –ë–î, –ø–µ—Ä–µ—à–∞–≥–∏–≤–∞—è practice-—Ç–µ–º—ã. –ï—Å–ª–∏ current topic ‚Äî practice, lesson –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –Ω–∞ task state —á–µ—Ä–µ–∑ `return "already_completed"`. –ò–Ω–∞—á–µ work products —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–¥ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º topic_index –∏ –ø—Ä–æ–ø–∞–¥–∞—é—Ç –∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

### 10.4. –ó–∞–º–µ—Ç–∫–∏ (fleeting-notes.md)

–§–æ—Ä–º–∞—Ç –∑–∞–º–µ—Ç–æ–∫ –∏ –ª–æ–≥–∏–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≤ `clients/github_api.py` –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ `fleeting-notes.md`.
–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞ (—à–∞–ø–∫–∞, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏) ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å `_find_insert_position`.

### 10.5. Keyboard Management Policy

**–î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:** –∫–∞–∂–¥—ã–π —Å—Ç–µ–π—Ç –æ–±—ä—è–≤–ª—è–µ—Ç `keyboard_type` –Ω–∞ –∫–ª–∞—Å—Å–µ. SM engine –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç–∏—Ç Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ **–ª—é–±–æ–π** non-reply —Å—Ç–µ–π—Ç (—á–µ—Ä–µ–∑ `_pending_keyboard_cleanup` –≤ `BaseState.send()`). –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞ —Ç–æ–∂–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç cleanup (`_keyboard_verified` –≤ SM).

**Keyboard Registry (19 —Å—Ç–µ–π—Ç–æ–≤):**

| State | keyboard_type | –ö–Ω–æ–ø–∫–∏ |
|-------|:---:|---|
| common.start | `none` | –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ |
| common.mode_select | `inline` | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é —Å–µ—Ä–≤–∏—Å–æ–≤ |
| common.settings | `inline` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (edit_text sub-nav) |
| common.profile | `inline` | –ü—Ä–æ—Ñ–∏–ª—å (edit_text sub-nav) |
| common.consultation | `none` | –ú–æ–¥–∞–ª—å–Ω—ã–π, inline-—Ñ–∏–¥–±–µ–∫ |
| common.plans | `inline` | Day/Week –ø–ª–∞–Ω (edit_text) |
| common.error | **`reply`** | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å / –ù–∞–∑–∞–¥ |
| workshop.marathon.lesson | `inline` | Retry / Back (–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥) |
| workshop.marathon.question | **`reply`** | –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ–º—É |
| workshop.marathon.bonus | **`reply`** | –î–∞ / –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ |
| workshop.marathon.task | **`reply`** | –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É |
| workshop.assessment.flow | `inline` | –î–∞/–ù–µ—Ç, self-check (edit_text) |
| workshop.assessment.result | `inline` | –ú–∞—Ä–∞—Ñ–æ–Ω / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –ù–∞–∑–∞–¥ |
| feed.topics | `inline` | –ß–µ–∫–±–æ–∫—Å—ã —Ç–µ–º |
| feed.digest | `inline` | –ü–æ–¥—Ä–æ–±–Ω–µ–µ / –§–∏–∫—Å–∞—Ü–∏—è / –ù–∞–∑–∞–¥ |
| utility.progress | `inline` | 6 —Å–µ–∫—Ü–∏–π (edit_text hub) |
| utility.mydata | `inline` | 3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ + Why |
| utility.feedback | `inline` | –ë–∞–≥/–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚Üí severity |

**SM auto-cleanup:** –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ **–ª—é–±–æ–π** —Å—Ç–µ–π—Ç —Å `keyboard_type != "reply"` SM –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `ReplyKeyboardRemove()` –≤ `BaseState._pending_keyboard_cleanup[chat_id]`. –¢–∞–∫–∂–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ (`_keyboard_verified`). –ü–µ—Ä–≤—ã–π `send()` –Ω–æ–≤–æ–≥–æ —Å—Ç–µ–π—Ç–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç cleanup:
- **–ë–µ–∑ reply_markup:** –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç `ReplyKeyboardRemove` –∫ —Å–æ–æ–±—â–µ–Ω–∏—é (0 extra API calls).
- **–° InlineKeyboardMarkup:** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç —Å `ReplyKeyboardRemove`, –∑–∞—Ç–µ–º `edit_reply_markup` –¥–ª—è InlineKeyboard (`send+edit`, +1 API call). **Fallback (3 —Å—Ç—É–ø–µ–Ω–∏):** edit_reply_markup ‚Üí edit_text ‚Üí delete + –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å InlineKeyboard. **–ò–∑–≤–µ—Å—Ç–Ω—ã–π –±–∞–≥ Telegram API:** edit –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å ReplyKeyboardRemove –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å —Å "message can't be edited" ‚Äî –ø–æ—ç—Ç–æ–º—É —Ñ–∏–Ω–∞–ª—å–Ω—ã–π fallback –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.
- **–° ReplyKeyboardMarkup:** –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç cleanup (–Ω–æ–≤–∞—è Reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—É—é).
- **Overhead:** ~50ms –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –≤ non-reply —Å—Ç–µ–π—Ç (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ InlineKeyboard). `ReplyKeyboardRemove` –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã = no-op –≤ Telegram API.

**–ü—Ä–∞–≤–∏–ª–∞ (defense-in-depth):**

1. **Reply-—Å—Ç–µ–π—Ç**: `keyboard_type = "reply"` + –Ω–∞ –∫–∞–∂–¥–æ–º exit-–ø—É—Ç–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π send() —Å–æ–¥–µ—Ä–∂–∏—Ç `reply_markup=ReplyKeyboardRemove()` (—Ä—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ ‚Äî primary, SM auto-cleanup ‚Äî safety net –¥–ª—è command-bypass –ø—É—Ç–∏).
2. **Callback-–ø–µ—Ä–µ—Ö–æ–¥**: handler –û–ë–Ø–ó–ê–ù –≤—ã–∑–≤–∞—Ç—å `callback.message.edit_reply_markup()` –ø–µ—Ä–µ–¥ `go_to()`.
3. **Inline sub-–Ω–∞–≤–∏–≥–∞—Ü–∏—è**: `edit_text()` ‚Äî –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è, stale –∫–Ω–æ–ø–æ–∫ –Ω–µ—Ç.
4. **Stale inline –∫–Ω–æ–ø–∫–∏**: –¥–æ–ø—É—Å—Ç–∏–º—ã. Fallback handler ‚Üí `fsm.button_expired` toast.
5. **–ù–æ–≤—ã–π —Å—Ç–µ–π—Ç**: —É—Å—Ç–∞–Ω–æ–≤–∏ `keyboard_type`, –æ–±–Ω–æ–≤–∏ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É.
6. **keyboards.py**: shared-–±–∏–ª–¥–µ—Ä—ã ‚Üí —Å—é–¥–∞. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ inline (1-2 –∫–Ω–æ–ø–∫–∏) ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ inline.

**–ü—Ä–æ—Ü–µ—Å—Å:** —Å–º. `PROCESSES.md ¬ß 5. Keyboard Lifecycle`.

### 10.6. CJK-—Å—Ç—Ä–æ–∫–∏: outer single quotes

Fullwidth quotes `"..."` (U+201C/U+201D) –≤–Ω—É—Ç—Ä–∏ Python `"..."` ‚Üí `SyntaxError`. CJK-–∫–æ–Ω—Ç–µ–Ω—Ç –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤ single quotes: `'Êù•Ëá™"‰∏™‰∫∫ÂèëÂ±ï"È°πÁõÆÁöÑ‰∏ªÈ¢ò„ÄÇ'`.

### 10.7. –≠–º–æ–¥–∑–∏: —Ç–æ–ª—å–∫–æ –≤ i18n, –Ω–µ –≤ –∫–æ–¥–µ

–ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –≤ schema.yaml —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–º–æ–¥–∑–∏ (`"‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é..."`, `"üîç –ò—â—É..."`), **–Ω–µ –¥–æ–±–∞–≤–ª—è–π** —ç–º–æ–¥–∑–∏ –≤ Python-–∫–æ–¥–µ (`f"‚è≥ {t(key)}"`). –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –¥–≤–æ–π–Ω–∞—è —ç–º–æ–¥–∑–∏. –ü—Ä–∞–≤–∏–ª–æ: —ç–º–æ–¥–∑–∏ –≤ UI ‚Üí —Ç–æ–ª—å–∫–æ –≤ schema.yaml.

### 10.8. YAML schema.yaml: –∑–∞–ø—Ä–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è top-level –∫–ª—é—á–µ–π

`yaml.safe_load()` –ø—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ top-level –∫–ª—é—á–∞ –º–æ–ª—á–∞ –∑–∞—Ç–∏—Ä–∞–µ—Ç –ø–µ—Ä–≤—ã–π ‚Üí –∫–ª—é—á–∏ –ø—Ä–æ–ø–∞–¥–∞—é—Ç ‚Üí `t()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä—ã–µ –∫–ª—é—á–∏. –ü—Ä–æ–≤–µ—Ä—è–π: `grep -n '^[a-z_]*:$' schema.yaml | sort | uniq -d` –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è `translations/*.yaml`.

### 10.9. Back –≤ inline sub-–Ω–∞–≤–∏–≥–∞—Ü–∏–∏: delete + enter

–ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–∑ –ø–æ–¥–º–µ–Ω—é (edit_text) –ù–ï –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å –≥–æ–ª—ã–π `self.enter(user)` ‚Äî —ç—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Å—Ç–∞–≤–ª—è—è —Å—Ç–∞—Ä–æ–µ. –ü–∞—Ç—Ç–µ—Ä–Ω: `callback.message.delete()` ‚Üí `self.enter(user)`.

### 10.10. Marathon day ‚Äî —Ç–æ–ª—å–∫–æ `core.topics.get_marathon_day(intern)`

SM states **–û–ë–Ø–ó–ê–ù–´** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `core.topics.get_marathon_day(intern)` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–Ω—è –º–∞—Ä–∞—Ñ–æ–Ω–∞. –ù–µ–ª—å–∑—è —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Å–≤–æ—é –≤–µ—Ä—Å–∏—é ‚Äî –ø–æ–ª–µ `marathon_start_date` + Moscow TZ (–ú–°–ö) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã. –°–≤–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `marathon_started_at` + UTC ‚Üí —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–∞ 1 –¥–µ–Ω—å.

---

## SOTA: Context Engineering (DP.SOTA.002)

> –ë–æ—Ç ‚Äî surface view –Ω–∞–¥ Pack –∏ DDT. –ö–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞ = –ø—Ä–æ–µ–∫—Ü–∏—è, –Ω–µ –∫–æ–ø–∏—è.

- –ö–∞–∂–¥—ã–π state machine state = bounded context —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –û—Ç–≤–µ—Ç—ã –±–æ—Ç–∞ = view over DDT/Pack, –Ω–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ state ‚Üí –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å: —á—Ç–æ –≤ always-in-context? —á—Ç–æ on-demand?
- MCP tools = select-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –∞–≥–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏
