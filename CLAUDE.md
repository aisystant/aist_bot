# CLAUDE.md ‚Äî AIST_me_bot (new-architecture)

> **–û–±—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:** —Å–º. `/Users/tserentserenov/Github/CLAUDE.md`
>
> –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –¥–∞–Ω–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

---

## 1. –¢–∏–ø —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

**Downstream-instrument** ‚Äî Telegram-–±–æ—Ç –º–∞—Ä–∞—Ñ–æ–Ω–∞ –ª–∏—á–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è.

**–ù–ï —è–≤–ª—è–µ—Ç—Å—è source-of-truth** ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤ Pack'–∞—Ö.

**–í–µ—Ç–∫–∏:** `pilot` (—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞) ‚Üí `new-architecture` (–ø—Ä–æ–¥). –ü—Ä–∞–≤–∏–ª–æ Pilot-First ‚Äî —Å–º. MEMORY.md.

---

## 2. –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è

**–í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω—ã –∏–∑ [ontology.md](ontology.md).**

### 2.1. –ö—Ä–∞—Ç–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞

| –¢–µ—Ä–º–∏–Ω | –ß—Ç–æ —ç—Ç–æ |
|--------|---------|
| **–£—á–µ–Ω–∏–∫** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ú–∞—Ä–∞—Ñ–æ–Ω–∞ |
| **–ß–∏—Ç–∞—Ç–µ–ª—å** | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –õ–µ–Ω—Ç—ã |
| **–ú–∞—Ä–∞—Ñ–æ–Ω** | 14-–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ |
| **–õ–µ–Ω—Ç–∞** | –ì–∏–±–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ –ø–æ –¥–∞–π–¥–∂–µ—Å—Ç–∞–º |
| **–£—Ä–æ–∫** | –¢–µ–æ—Ä–∏—è –≤ –ú–∞—Ä–∞—Ñ–æ–Ω–µ |
| **–ó–∞–¥–∞–Ω–∏–µ** | –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤ –ú–∞—Ä–∞—Ñ–æ–Ω–µ |
| **–î–∞–π–¥–∂–µ—Å—Ç** | –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –≤ –õ–µ–Ω—Ç–µ |
| **–§–∏–∫—Å–∞—Ü–∏—è** | –õ–∏—á–Ω—ã–π –≤—ã–≤–æ–¥ –ß–∏—Ç–∞—Ç–µ–ª—è |

### 2.2. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–¥–∞ –∏ —Ç–µ—Ä–º–∏–Ω–æ–≤

| –¢–µ—Ä–º–∏–Ω | –í –∫–æ–¥–µ —Å–µ–π—á–∞—Å | –¶–µ–ª–µ–≤–æ–µ –∏–º—è |
|--------|---------------|-------------|
| –£—Ä–æ–∫ | `theory` | `lesson` |
| –ó–∞–¥–∞–Ω–∏–µ | `practice` | `task` |
| –î–∞–π–¥–∂–µ—Å—Ç | `feed_session` | `digest` |

---

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–º–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

```
aist_bot/
‚îú‚îÄ‚îÄ bot.py                    # –¢–æ–Ω–∫–∏–π –∫–ª–∏–µ–Ω—Ç (~246 —Å—Ç—Ä–æ–∫): config + imports + main()
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ machine.py            # –î–≤–∏–∂–æ–∫ State Machine (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ dispatcher.py         # –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–æ—É—Ç–∏–Ω–≥ (mode-aware /learn)
‚îÇ   ‚îú‚îÄ‚îÄ topics.py             # –î–æ–º–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ç–µ–º: TOPICS, get_marathon_day, save_answer
‚îÇ   ‚îú‚îÄ‚îÄ scheduler.py          # –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ storage.py            # PostgresStorage (FSM persistence)
‚îÇ   ‚îú‚îÄ‚îÄ middleware.py          # LoggingMiddleware
‚îÇ   ‚îú‚îÄ‚îÄ helpers.py            # MODE_STATE_MAP, get_user_mode_state
‚îÇ   ‚îú‚îÄ‚îÄ intent.py             # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ knowledge.py          # –ü–æ–∏—Å–∫ –ø–æ MCP
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py           # setup_handlers(dp, dispatcher), setup_fallback(dp)
‚îÇ   ‚îú‚îÄ‚îÄ commands.py           # –¢–æ–Ω–∫–∏–µ –æ–±—ë—Ä—Ç–∫–∏: /learn, /feed, /mode ‚Üí dispatcher
‚îÇ   ‚îú‚îÄ‚îÄ callbacks.py          # Callback queries ‚Üí dispatcher
‚îÇ   ‚îú‚îÄ‚îÄ onboarding.py         # /start + OnboardingStates
‚îÇ   ‚îú‚îÄ‚îÄ settings.py           # /profile, /help, /update, /language + UpdateStates
‚îÇ   ‚îú‚îÄ‚îÄ progress.py           # /progress + full report
‚îÇ   ‚îú‚îÄ‚îÄ linear.py             # /linear –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ twin.py               # /twin —Ü–∏—Ñ—Ä–æ–≤–æ–π –¥–≤–æ–π–Ω–∏–∫
‚îÇ   ‚îî‚îÄ‚îÄ fallback.py           # Catch-all: SM routing
‚îú‚îÄ‚îÄ states/                   # State Machine —Å—Ç–µ–π—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ common/               # start, mode_select, settings
‚îÇ   ‚îú‚îÄ‚îÄ workshops/marathon/   # lesson, question, bonus, task
‚îÇ   ‚îú‚îÄ‚îÄ feed/                 # topics, digest
‚îÇ   ‚îî‚îÄ‚îÄ utilities/            # progress
‚îú‚îÄ‚îÄ engines/                  # –†–µ–∂–∏–º—ã (mode_selector, feed)
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ settings.py           # –í—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ transitions.yaml      # –¢–∞–±–ª–∏—Ü–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ SM
‚îú‚îÄ‚îÄ clients/                  # Claude API, MCP –∫–ª–∏–µ–Ω—Ç—ã
‚îú‚îÄ‚îÄ db/                       # PostgreSQL queries
‚îú‚îÄ‚îÄ i18n/                     # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
‚îú‚îÄ‚îÄ integrations/telegram/    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îî‚îÄ‚îÄ docs/                     # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

### 3.1. –ü—Ä–∞–≤–∏–ª–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–ü–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤ (–∫—Ä–∏—Ç–∏—á–Ω–æ!):** engines ‚Üí handlers ‚Üí fallback –ü–û–°–õ–ï–î–ù–ò–ú.

**–ò–º–ø–æ—Ä—Ç—ã ‚Äî –æ—Ç–∫—É–¥–∞ —á—Ç–æ –±—Ä–∞—Ç—å:**

| –ß—Ç–æ –Ω—É–∂–Ω–æ | –û—Ç–∫—É–¥–∞ | –ù–ï –∏–∑ |
|-----------|--------|-------|
| –î–æ–º–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (get_marathon_day, TOPICS, save_answer) | `core.topics` | ~~bot~~ |
| –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã (BLOOM_AUTO_UPGRADE_AFTER, STUDY_DURATIONS) | `config` | ~~bot~~ |
| –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (kb_update_profile) | `integrations.telegram.keyboards` | ~~bot~~ |
| FSM —Å—Ç–µ–π—Ç—ã (UpdateStates) | `handlers.settings` | ~~bot~~ |
| `claude`, `state_machine` | `bot` | –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –ª–µ–≥–∏—Ç–∏–º–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –∏–∑ bot.py |

**Lazy imports (`_bot_imports()`)** ‚Äî –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ handlers/ –¥–ª—è —Ä–∞–∑—Ä—ã–≤–∞ circular dependencies. –í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–π, –Ω–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è.

**bot.py ‚Äî re-exports:** bot.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å—ë –∏–∑ core/topics, handlers/ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –ù–æ–≤—ã–π –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–∞–ø—Ä—è–º—É—é.

---

## 4. –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û–ø–∏—Å—ã–≤–∞–µ—Ç | –ü–∞–ø–∫–∞ |
|-----------|-----------|-------|
| **–°—Ü–µ–Ω–∞—Ä–∏–π** | –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–æ—Ç–æ–º | `docs/scenarios/` |
| **–ü—Ä–æ—Ü–µ—Å—Å** | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ | `docs/processes/` |
| **–î–∞–Ω–Ω—ã–µ** | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î | `docs/data/` |

---

## 5. –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 5.1. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ ‚Äî –°–ü–†–û–°–ò

**–õ—é–±–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç:**
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–°—Ü–µ–Ω–∞—Ä–∏–π/–ü—Ä–æ—Ü–µ—Å—Å/–î–∞–Ω–Ω—ã–µ)
2. –°–ø—Ä–æ—Å–∏—Ç—å: "–≠—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞—Ç—Ä–æ–Ω–µ—Ç [–∫–∞—Ç–µ–≥–æ—Ä–∏—è]. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ?"
3. –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. –ö–æ–¥ + –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –æ–¥–Ω–æ–º –∫–æ–º–º–∏—Ç–µ

### 5.2. README.md

–ò–∑–º–µ–Ω—è—Ç—å **—Ç–æ–ª—å–∫–æ —Å —è–≤–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.

---

## 6. –†–∞–±–æ—Ç–∞ —Å –≤–µ—Ç–∫–∞–º–∏

| –í–µ—Ç–∫–∞ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-------|------------|
| `main` | Production |
| `new-architecture` | State Machine (—ç—Ç–∞ –≤–µ—Ç–∫–∞) |

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å main

- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞—Ç—å `rebase` –Ω–∞ main
- –ù–µ –º–µ—Ä–∂–∏—Ç—å –≤ main –¥–æ –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
- –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –∑–∞ feature flags

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –º–µ—Ä–∂—É

- [ ] –í—Å–µ —Å—Ç–µ–π—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
- [ ] Feature flag —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Smoke test –ø—Ä–æ—Ö–æ–¥–∏—Ç
- [ ] E2E —Ç–µ—Å—Ç—ã –≤ Telegram –ø—Ä–æ–π–¥–µ–Ω—ã

---

## 7. –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º

### –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è
- [ ] –¢–µ—Ä–º–∏–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç `ontology.md`
- [ ] –°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- [ ] –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏–º–µ–Ω–∞

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è
- [ ] –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

---

## 8. State Machine ‚Äî –ø—Ä–∞–≤–∏–ª–∞

- **enter()** –î–û–õ–ñ–ï–ù –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å—Ç—Ä–æ–∫—É-—Å–æ–±—ã—Ç–∏–µ –≤–æ –í–°–ï–• –≤–µ—Ç–∫–∞—Ö –≤—ã—Ö–æ–¥–∞. `return` –±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏—è = —Å—Ç–µ–π—Ç –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç.
- –ö–∞–∂–¥–æ–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ —Å–æ–±—ã—Ç–∏–µ –î–û–õ–ñ–ù–û –±—ã—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ `config/transitions.yaml`.
- **handle()** –ù–ï –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –Ω–∞ –ª—é–±–æ–π –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä—è–π –æ–∂–∏–¥–∞–µ–º—ã–π –≤–≤–æ–¥.
- **go_to() silent return:** –ø—Ä–æ–≤–µ—Ä—è–π —Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–π `context`, –Ω–µ `full_context` (—Å exit_context). –ò–Ω–∞—á–µ exit() –º–æ–¥–∞–ª—å–Ω–æ–≥–æ —Å—Ç–µ–π—Ç–∞ (consultation_complete) –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã (/learn –∏ –¥—Ä.) –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ —Å—Ç–µ–π—Ç–∞.
- **go_to() + _previous:** –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –º–æ–¥–∞–ª—å–Ω—ã–π —Å—Ç–µ–π—Ç —á–µ—Ä–µ–∑ go_to() ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π previous_state. –ò–Ω–∞—á–µ _previous –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ callback-–≤—ã–∑–æ–≤–∞ (‚úèÔ∏è/üîç) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

---

## 9. Claude API ‚Äî –ø—Ä–∞–≤–∏–ª–∞

- **Streaming SSE** (`_api_call_streaming`) –¥–ª—è `generate()`. Non-streaming (`_api_call`) ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è `generate_with_tools()`.
- **Inactivity timeout** –≤–º–µ—Å—Ç–æ total: `sock_read = max(15, max_tokens / 200)`. Total timeout (45s) –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è —Å –¥–ª–∏–Ω–æ–π –≤—ã–≤–æ–¥–∞.
- **Adaptive max_tokens** –≤ `generate_content`: `min(words √ó 1.5, 4096)`. –ù–µ hardcode 4000.
- **Scheduler retry**: –ø—Ä–∏ —Ñ–µ–π–ª–µ –ø—Ä–µ-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ‚Üí `_schedule_retry()` —Å—Ç–∞–≤–∏—Ç one-off job –Ω–∞ +30 –º–∏–Ω (APScheduler `date` trigger, dedup –ø–æ job_id).
- **Content Budget Model (DP.D.027)** ‚Äî 3 –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ—Å–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:
  - **–û—Å—å 1 (–î–ª–∏–Ω–∞):** `words = duration √ó WPM_BASE(60) √ó BLOOM_MULTIPLIER[bloom]` (–º–Ω–æ–∂–∏—Ç–µ–ª–∏: 1‚Üí1.0, 2‚Üí1.3, 3‚Üí1.7). –§—É–Ω–∫—Ü–∏—è: `config.calc_words()`.
  - **–û—Å—å 2 (–ì–ª—É–±–∏–Ω–∞):** `BLOOM_INSTRUCTION[bloom]` ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ system prompt, —É–ø—Ä–∞–≤–ª—è—é—â–∞—è —Å—Ç–∏–ª–µ–º (–¥–æ—Å—Ç—É–ø–Ω—ã–π ‚Üí –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π ‚Üí —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π).
  - **–û—Å—å 3 (–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è):** –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + assessment state + DT (tier context).
  - **–ü—Ä–∞–≤–∏–ª–æ:** –î–ª–∏–Ω–∞ –∏ –≥–ª—É–±–∏–Ω–∞ –ù–ï –î–û–õ–ñ–ù–´ —Å–º–µ—à–∏–≤–∞—Ç—å—Å—è. Bloom –≤–ª–∏—è–µ—Ç –Ω–∞ –æ–±—ä—ë–º —á–µ—Ä–µ–∑ –º–Ω–æ–∂–∏—Ç–µ–ª—å (–û—Å—å 1) –ò –Ω–∞ —Å—Ç–∏–ª—å —á–µ—Ä–µ–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é (–û—Å—å 2) ‚Äî —Ä–∞–∑–¥–µ–ª—å–Ω–æ.

---

## 10. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

| –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ | –ü—Ä–∞–≤–∏–ª—å–Ω–æ |
|-------------|-----------|
| "–∫–æ–Ω—Ç–µ–Ω—Ç" (–≤ –õ–µ–Ω—Ç–µ) | –î–∞–π–¥–∂–µ—Å—Ç |
| "—Ç–µ–º–∞" | –£—Ä–æ–∫ / –ó–∞–¥–∞–Ω–∏–µ / –î–∞–π–¥–∂–µ—Å—Ç |
| "—Å–µ—Å—Å–∏—è" | –î–∞–π–¥–∂–µ—Å—Ç / –î–µ–Ω—å |
| "—Ä–µ—Ñ–ª–µ–∫—Å–∏—è" | –§–∏–∫—Å–∞—Ü–∏—è |
| "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" | –£—á–µ–Ω–∏–∫ / –ß–∏—Ç–∞—Ç–µ–ª—å |

### Anti-hallucination –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞

1. **–ì—Ä–∞–Ω–∏—Ü–∞ –∑–Ω–∞–Ω–∏–π = –ø—Ä–∞–≤–∏–ª–æ #1** (question_handler.py). –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ¬´–ù–ï –¥–æ–¥—É–º—ã–≤–∞–π¬ª –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–≤–æ–π, –Ω–µ —Ç—Ä–µ—Ç—å–µ–π ‚Äî –∏–Ω–∞—á–µ –∫–æ–Ω–∫—É—Ä–∏—Ä—É–µ—Ç —Å –¥—Ä—É–≥–∏–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏.
2. **Depth instruction ‚Üí ¬´–∏—Å–ø–æ–ª—å–∑—É–π –í–°–ï –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞¬ª**, –∞ –ù–ï ¬´–æ–±—ä—è—Å–Ω–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã, –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã¬ª ‚Äî –≤—Ç–æ—Ä–æ–µ –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏.
3. **Structured data > MCP** –¥–ª—è —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: `previous_days_connection` –∏–∑ topic YAML ‚Üí `format_structured_context()` ‚Üí –º–æ–¥–µ–ª—å –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–µ—Ç —Å–≤—è–∑–∏.

---

## 10. –õ–æ–≤—É—à–∫–∏ i18n –∏ UI

### 10.1. Markdown-–∫—Ä–∞—à –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–∞

`t()` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–ª—é—á–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∫–ª—é—á–∞ (–Ω–∞–ø—Ä. `"help.about_marathon"`).
–ï—Å–ª–∏ –≤ –Ω–µ–π `_` ‚Äî Telegram –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ –∫—É—Ä—Å–∏–≤ ‚Üí `TelegramBadRequest: can't parse entities`.

**–ü—Ä–∞–≤–∏–ª–æ:** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ `t()` –≤—ã–∑–æ–≤–∞ ‚Äî —É–±–µ–¥–∏—Å—å, —á—Ç–æ –∫–ª—é—á —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ schema.yaml + es.yaml + fr.yaml.

### 10.2. Markdown fallback –¥–ª—è Claude-–∫–æ–Ω—Ç–µ–Ω—Ç–∞

–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ LLM-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —Å `parse_mode="Markdown"` ‚Äî **–≤—Å–µ–≥–¥–∞** –æ–±–æ—Ä–∞—á–∏–≤–∞–π –≤ `try/except` —Å fallback –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. Claude –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (`*`, `_`, `[`), –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–º–∞—é—Ç Telegram API (`TelegramBadRequest: can't parse entities`).

### 10.3. State –Ω–µ –¥–æ–ª–∂–µ–Ω –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å DB-—É–∫–∞–∑–∞—Ç–µ–ª—å —á—É–∂–æ–≥–æ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

Lesson state (theory) **–Ω–µ –¥–æ–ª–∂–µ–Ω** –º–µ–Ω—è—Ç—å `current_topic_index` –≤ –ë–î, –ø–µ—Ä–µ—à–∞–≥–∏–≤–∞—è practice-—Ç–µ–º—ã. –ï—Å–ª–∏ current topic ‚Äî practice, lesson –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –Ω–∞ task state —á–µ—Ä–µ–∑ `return "already_completed"`. –ò–Ω–∞—á–µ work products —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ–¥ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º topic_index –∏ –ø—Ä–æ–ø–∞–¥–∞—é—Ç –∏–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.

### 10.4. –ó–∞–º–µ—Ç–∫–∏ (fleeting-notes.md)

–§–æ—Ä–º–∞—Ç –∑–∞–º–µ—Ç–æ–∫ –∏ –ª–æ–≥–∏–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –≤ `clients/github_api.py` –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–µ `fleeting-notes.md`.
–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–∞ (—à–∞–ø–∫–∞, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏) ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å `_find_insert_position`.

### 10.5. Naive datetime –¥–ª—è TIMESTAMP –∫–æ–ª–æ–Ω–æ–∫

**–ü—Ä–∞–≤–∏–ª–æ:** –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ DB (–∫—Ä–æ–º–µ `error_logs` –∏ `request_traces`) –∏—Å–ø–æ–ª—å–∑—É—é—Ç `TIMESTAMP` (naive). –ü—Ä–∏ –∑–∞–ø–∏—Å–∏ ‚Äî —Ç–æ–ª—å–∫–æ `datetime.utcnow()`, **–ù–ï** `datetime.now(timezone.utc)`. asyncpg —Å `statement_cache_size=0` (Neon) –Ω–µ –º–æ–∂–µ—Ç –∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å aware datetime –≤ naive –∫–æ–ª–æ–Ω–∫—É ‚Üí `DataError`.

### 10.6. Keyboard Management Policy (WP-52)

**–ü—Ä–∏–Ω—Ü–∏–ø:** SM –ù–ï —É–¥–∞–ª—è–µ—Ç ReplyKeyboard, –∞ –ó–ê–ú–ï–ù–Ø–ï–¢. Tier-based KB –∏–∑ mode_select –ø–µ—Ä—Å–∏—Å—Ç–∏—Ç —á–µ—Ä–µ–∑ inline-—Å—Ç–µ–π—Ç—ã. SM-contextual —Å—Ç–µ–π—Ç—ã (Phase 2) –∑–∞–º–µ–Ω—è—Ç –µ—ë –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é.

**–î–≤–∞ —Å–ª–æ—è ReplyKeyboard:**
1. **mode_select KB** (2√ó2) ‚Äî tier-based, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ mode_select
2. **SM-contextual KB** (Phase 2) ‚Äî Row 1: –¥–µ–π—Å—Ç–≤–∏—è —Å—Ç–µ–π—Ç–∞, Row 2: `[üè† –ú–µ–Ω—é] [‚öôÔ∏è]`

**Keyboard Registry (19 —Å—Ç–µ–π—Ç–æ–≤):**

| State | keyboard_type | –ö–Ω–æ–ø–∫–∏ |
|-------|:---:|---|
| common.start | `none` | –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ |
| common.mode_select | **`reply`** | Tier-based 2√ó2 ReplyKeyboard (tier_ui.py) |
| common.settings | `inline` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (edit_text sub-nav) |
| common.profile | `inline` | –ü—Ä–æ—Ñ–∏–ª—å (edit_text sub-nav) |
| common.consultation | `none` | –ú–æ–¥–∞–ª—å–Ω—ã–π, inline-—Ñ–∏–¥–±–µ–∫ |
| common.plans | `inline` | Day/Week –ø–ª–∞–Ω (edit_text) |
| common.error | **`reply`** | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å / –ù–∞–∑–∞–¥ |
| workshop.marathon.lesson | `inline` | Retry / Back (–∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥) |
| workshop.marathon.question | **`reply`** | –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ–º—É |
| workshop.marathon.bonus | **`reply`** | –î–∞ / –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ |
| workshop.marathon.task | **`reply`** | –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É |
| workshop.assessment.flow | `inline` | –î–∞/–ù–µ—Ç, self-check (edit_text) |
| workshop.assessment.result | `inline` | –ú–∞—Ä–∞—Ñ–æ–Ω / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ / –ù–∞–∑–∞–¥ |
| feed.topics | `inline` | –ß–µ–∫–±–æ–∫—Å—ã —Ç–µ–º |
| feed.digest | `inline` | –ü–æ–¥—Ä–æ–±–Ω–µ–µ / –§–∏–∫—Å–∞—Ü–∏—è / –ù–∞–∑–∞–¥ |
| utility.progress | `inline` | 6 —Å–µ–∫—Ü–∏–π (edit_text hub) |
| utility.mydata | `inline` | Hub (5 —Å–µ–∫—Ü–∏–π) + delete confirm (text input) |
| utility.feedback | `inline` | –ë–∞–≥/–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ ‚Üí severity |

**SM keyboard persistence:** SM –±–æ–ª—å—à–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç ReplyKeyboard –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. `_pending_keyboard_cleanup` –≤ base.py –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è backwards compat –Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è. ReplyKeyboard –∏–∑ mode_select –ø–µ—Ä—Å–∏—Å—Ç–∏—Ç —á–µ—Ä–µ–∑ –≤—Å–µ inline-—Å—Ç–µ–π—Ç—ã. Reply-—Å—Ç–µ–π—Ç—ã (question, bonus, task) –∑–∞–º–µ–Ω—è—é—Ç tier-KB –Ω–∞ —Å–≤–æ—é; –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ mode_select tier-KB –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

**–ü—Ä–∞–≤–∏–ª–∞:**

1. **Reply-—Å—Ç–µ–π—Ç**: `keyboard_type = "reply"` + –Ω–∞ –∫–∞–∂–¥–æ–º exit-–ø—É—Ç–∏ `send_remove_keyboard()` (–æ—á–∏—Å—Ç–∫–∞ —Å–≤–æ–µ–π KB –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –≤ mode_select).
2. **Callback-–ø–µ—Ä–µ—Ö–æ–¥**: handler –û–ë–Ø–ó–ê–ù –≤—ã–∑–≤–∞—Ç—å `callback.message.edit_reply_markup()` –ø–µ—Ä–µ–¥ `go_to()`.
3. **Inline sub-–Ω–∞–≤–∏–≥–∞—Ü–∏—è**: `edit_text()` ‚Äî –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è, stale –∫–Ω–æ–ø–æ–∫ –Ω–µ—Ç.
4. **Stale inline –∫–Ω–æ–ø–∫–∏**: –¥–æ–ø—É—Å—Ç–∏–º—ã. Fallback handler ‚Üí `fsm.button_expired` toast.
5. **–ù–æ–≤—ã–π —Å—Ç–µ–π—Ç**: —É—Å—Ç–∞–Ω–æ–≤–∏ `keyboard_type`, –æ–±–Ω–æ–≤–∏ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É.
6. **keyboards.py**: shared-–±–∏–ª–¥–µ—Ä—ã ‚Üí —Å—é–¥–∞. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ inline (1-2 –∫–Ω–æ–ø–∫–∏) ‚Äî –¥–æ–ø—É—Å—Ç–∏–º–æ inline.

**–ü—Ä–æ—Ü–µ—Å—Å:** —Å–º. `PROCESSES.md ¬ß 5. Keyboard Lifecycle`.

### 10.6. CJK-—Å—Ç—Ä–æ–∫–∏: outer single quotes

Fullwidth quotes `"..."` (U+201C/U+201D) –≤–Ω—É—Ç—Ä–∏ Python `"..."` ‚Üí `SyntaxError`. CJK-–∫–æ–Ω—Ç–µ–Ω—Ç –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤ single quotes: `'Êù•Ëá™"‰∏™‰∫∫ÂèëÂ±ï"È°πÁõÆÁöÑ‰∏ªÈ¢ò„ÄÇ'`.

### 10.7. –≠–º–æ–¥–∑–∏: —Ç–æ–ª—å–∫–æ –≤ i18n, –Ω–µ –≤ –∫–æ–¥–µ

–ï—Å–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ –≤ schema.yaml —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç–º–æ–¥–∑–∏ (`"‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é..."`, `"üîç –ò—â—É..."`), **–Ω–µ –¥–æ–±–∞–≤–ª—è–π** —ç–º–æ–¥–∑–∏ –≤ Python-–∫–æ–¥–µ (`f"‚è≥ {t(key)}"`). –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –¥–≤–æ–π–Ω–∞—è —ç–º–æ–¥–∑–∏. –ü—Ä–∞–≤–∏–ª–æ: —ç–º–æ–¥–∑–∏ –≤ UI ‚Üí —Ç–æ–ª—å–∫–æ –≤ schema.yaml.

### 10.8. YAML schema.yaml: –∑–∞–ø—Ä–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è top-level –∫–ª—é—á–µ–π

`yaml.safe_load()` –ø—Ä–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–∏ top-level –∫–ª—é—á–∞ –º–æ–ª—á–∞ –∑–∞—Ç–∏—Ä–∞–µ—Ç –ø–µ—Ä–≤—ã–π ‚Üí –∫–ª—é—á–∏ –ø—Ä–æ–ø–∞–¥–∞—é—Ç ‚Üí `t()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä—ã–µ –∫–ª—é—á–∏. –ü—Ä–æ–≤–µ—Ä—è–π: `grep -n '^[a-z_]*:$' schema.yaml | sort | uniq -d` –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è `translations/*.yaml`.

### 10.9. Back –≤ inline sub-–Ω–∞–≤–∏–≥–∞—Ü–∏–∏: delete + enter

–ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–∑ –ø–æ–¥–º–µ–Ω—é (edit_text) –ù–ï –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å –≥–æ–ª—ã–π `self.enter(user)` ‚Äî —ç—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Å—Ç–∞–≤–ª—è—è —Å—Ç–∞—Ä–æ–µ. –ü–∞—Ç—Ç–µ—Ä–Ω: `callback.message.delete()` ‚Üí `self.enter(user)`.

### 10.10. Scheduler = read-only –¥–ª—è user state

Scheduler (`core/scheduler.py`) **–ù–ï –ò–ú–ï–ï–¢ –ü–†–ê–í–ê** –º–µ–Ω—è—Ç—å –ø–æ–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: `current_topic_index`, `completed_topics`, `bloom_level`. –≠—Ç–∏ –ø–æ–ª—è ‚Äî —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å FSM states (lesson/question/task). Scheduler –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç, –Ω–æ –∑–∞–ø–∏—Å—å –≤ –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏.

### 10.11. Marathon day ‚Äî —Ç–æ–ª—å–∫–æ `core.topics.get_marathon_day(intern)`

SM states **–û–ë–Ø–ó–ê–ù–´** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `core.topics.get_marathon_day(intern)` –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–Ω—è –º–∞—Ä–∞—Ñ–æ–Ω–∞. –ù–µ–ª—å–∑—è —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Å–≤–æ—é –≤–µ—Ä—Å–∏—é ‚Äî –ø–æ–ª–µ `marathon_start_date` + Moscow TZ (–ú–°–ö) –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã. –°–≤–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ `marathon_started_at` + UTC ‚Üí —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–∞ 1 –¥–µ–Ω—å.

### 10.12. dict.get() —Å None-–∑–Ω–∞—á–µ–Ω–∏–µ–º –≤ JSONB

`session.get('content', {})` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None` (–Ω–µ `{}`), –∫–æ–≥–¥–∞ –∫–ª—é—á `content` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º `None`. **–ü–∞—Ç—Ç–µ—Ä–Ω:** `session.get('content') or {}`. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `or {}` / `or []` –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ JSONB-–ø–æ–ª—è–º, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å `None`.

### 10.13. delete_webhook –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (Railway)

–ü—Ä–∏ —Ä–µ–¥–µ–ø–ª–æ–µ Railway —Å—Ç–∞—Ä—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –µ—â—ë polling, –∞ –Ω–æ–≤—ã–π —É–∂–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç ‚Üí `TelegramConflictError`. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:** `await bot.delete_webhook(drop_pending_updates=False)` –ø–µ—Ä–µ–¥ `dp.start_polling(bot)`.

### 10.14. Model Routing ‚Äî Haiku –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö, Sonnet –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö

–î–≤–∞ Claude-–º–æ–¥–µ–ª–∏: `CLAUDE_MODEL_SONNET` (default) –∏ `CLAUDE_MODEL_HAIKU` (config/settings.py). –†–æ—É—Ç–∏–Ω–≥ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞–¥–∞—á–∏:

| –ú–æ–¥–µ–ª—å | –ö–æ–≥–¥–∞ | –ü–æ—á–µ–º—É |
|--------|-------|--------|
| **Haiku** | feed ¬´why¬ª (planner.py), bot FAQ L1/L2 (consultation.py), /mydata –æ–±—ä—è—Å–Ω–µ–Ω–∏—è | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥, latency <3—Å, —Å—Ç–æ–∏–º–æ—Å—Ç—å √ó10 –Ω–∏–∂–µ |
| **Sonnet** | –£—Ä–æ–∫–∏, –ø—Ä–∞–∫—Ç–∏–∫–∞, –≤–æ–ø—Ä–æ—Å—ã, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ L3, tool_use | –ö—Ä–µ–∞—Ç–∏–≤–Ω—ã–π/—Å–ª–æ–∂–Ω—ã–π –≤—ã–≤–æ–¥, –Ω—É–∂–µ–Ω reasoning |

**–ü–∞—Ç—Ç–µ—Ä–Ω:** –≤—Å–µ `generate*()` –º–µ—Ç–æ–¥—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç `model=` –ø–∞—Ä–∞–º–µ—Ç—Ä. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é Sonnet. –í—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ –ø–µ—Ä–µ–¥–∞—ë—Ç `model=CLAUDE_MODEL_HAIKU` —è–≤–Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á.

### 10.15. Content Cache ‚Äî DB-–∫–µ—à –¥–ª—è practice intro –∏ questions

`db/queries/cache.py` ‚Äî –∫–µ—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `content_cache`. TTL = 7 –¥–Ω–µ–π.

| –ö–ª—é—á | –§–æ—Ä–º–∞—Ç | –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
|------|--------|------------------|
| `practice:{topic_id}:{lang}:{chat_id}` | –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ (per-user) | `generate_practice_intro()` |
| `question:{topic_id}:{bloom}:{lang}:{occupation}` | –í–æ–ø—Ä–æ—Å—ã | `generate_question()` |

**–ü—Ä–∞–≤–∏–ª–æ:** –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è, –ø—Ä–æ—Ñ–µ—Å—Å–∏—é, —Ü–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) –û–ë–Ø–ó–ê–ù –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å—Å—è per-user (`:{chat_id}`). –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à –¥–æ–ø—É—Å—Ç–∏–º —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏.

`cache_cleanup()` –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ scheduler –µ–∂–µ–¥–Ω–µ–≤–Ω–æ.

### 10.16. Slot suggestion –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ (‚â•50 users)

`MAX_USERS_PER_SLOT = 50` (db/queries/users.py). –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—É—á–µ–Ω–∏—è (onboarding + settings):
1. `get_slot_load(time)` ‚Üí —Å—á–∏—Ç–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ–∫–Ω–µ ¬±5 –º–∏–Ω (11 —Å–ª–æ—Ç–æ–≤)
2. –ï—Å–ª–∏ count ‚â• 50 ‚Üí `kb_slot_suggestions()` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ 3 üü¢ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ + üü° ¬´–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å¬ª
3. –≠—Ç–æ **–º—è–≥–∫–æ–µ** –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞—Å—Ç–æ—è—Ç—å –Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Å–ª–æ—Ç–µ

**–ó–∞—á–µ–º:** —Ä–∞—Å—Å—Ä–µ–¥–æ—Ç–æ—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ scheduler pre-generation. –ë–µ–∑ staggering ‚Äî –≤—Å–µ 50 users = 50 concurrent Claude API –≤—ã–∑–æ–≤–æ–≤ –≤ –æ–¥–Ω—É –º–∏–Ω—É—Ç—É.

### 10.17. config/__init__.py ‚Äî barrel file sync

–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ `config/settings.py` ‚Äî **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û** –¥–æ–±–∞–≤–∏—Ç—å –µ—ë –≤ –æ–±–∞ –º–µ—Å—Ç–∞ –≤ `config/__init__.py`: –±–ª–æ–∫ `from .settings import (...)` –ò —Å–ø–∏—Å–æ–∫ `__all__`. –ë–µ–∑ —ç—Ç–æ–≥–æ ‚Äî `ImportError` crash loop –Ω–∞ –¥–µ–ø–ª–æ–µ (IDE –Ω–µ –ª–æ–≤–∏—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ `from config.settings import X` —Ä–∞–±–æ—Ç–∞–µ—Ç, –∞ `from config import X` ‚Äî –Ω–µ—Ç).

### 10.18. Scheduler Log Noise ‚Äî –ø–æ–¥–∞–≤–ª–µ–Ω

apscheduler INFO-–ª–æ–≥–∏ (`Running job`, `executed successfully`) –ø–æ–¥–∞–≤–ª–µ–Ω—ã –¥–æ WARNING –≤ `bot.py`. FSM `get_state`/`set_state` –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ DEBUG. –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ scheduler ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—å INFO.

### 10.19. Look-Ahead Pre-Gen

–ü–æ—Å–ª–µ –¥–æ—Å—Ç–∞–≤–∫–∏ —É—Ä–æ–∫–∞/–ø—Ä–∞–∫—Ç–∏–∫–∏ `_pregen_next_topic_bg()` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Ç–µ–º—É –≤ —Ñ–æ–Ω–µ (`asyncio.create_task`, fire-and-forget). –ü–æ–∫—Ä—ã–≤–∞–µ—Ç —Å–ª—É—á–∞–π: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à—ë–ª –¥–æ scheduled delivery.

### 10.20. Haiku On-The-Fly Fallback

–ü—Ä–∏ cache miss lesson.py –∏ task.py –∏—Å–ø–æ–ª—å–∑—É—é—Ç `model=CLAUDE_MODEL_HAIKU` (3-5s –≤–º–µ—Å—Ç–æ 15-19s Sonnet). Pre-gen scheduler –∏ look-ahead –≤—Å–µ–≥–¥–∞ Sonnet (default). Worst case latency <5s.

### 10.21. PostgreSQL Views: DROP + CREATE, –Ω–µ REPLACE

`CREATE OR REPLACE VIEW` **–∑–∞–ø—Ä–µ—â—ë–Ω**. PostgreSQL –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–µ–Ω—è—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∏–ª–∏ –∏–º–µ–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ REPLACE ‚Äî –±–æ—Ç –ø–∞–¥–∞–µ—Ç –≤ crash loop –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –í—Å–µ–≥–¥–∞: `DROP VIEW IF EXISTS` + `CREATE VIEW`. View stateless ‚Äî –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è.

---

## 11. Error Classification (WP-45, DP.RUNBOOK.001)

**–ú–æ–¥—É–ª—å:** `core/error_classifier.py` ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç `error_logs` –ø–æ 6 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º RUNBOOK (fsm, db, claude_api, telegram_api, mcp, scheduler) + severity (L1-L4).

**–ü–æ—Ä—è–¥–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:** —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ (MCP, Claude, TG) ‚Üí generic (DB). First match wins. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–π, –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –ª–∏ generic (—Ç–µ—Å—Ç: 13 cases –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ WP-45 –∫–æ–º–º–∏—Ç—É).

**Scheduler:** classify_unprocessed() –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω + check_escalation() –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω.

**Grafana:** dashboard JSON –≤ `monitoring/grafana-dashboard.json` (PostgreSQL datasource ‚Üí Neon).

---

## 12. Progressive UI per Tier (WP-52 v4)

**–§–∞–π–ª—ã:** `core/tier_config.py`, `core/tier_detector.py`, `core/tier_ui.py`, `handlers/reply_keyboard.py`

**–î–∏–∑–∞–π–Ω-–¥–æ–∫—É–º–µ–Ω—Ç:** `DS-my-strategy/inbox/WP-52-progressive-ui-tiers.md`
**Pack-—Å—É—â–Ω–æ—Å—Ç—å:** DP.ARCH.002 ¬ß 13

**–î–≤–∞ —Å–ª–æ—è ReplyKeyboard:**
1. **mode_select KB** (2√ó2) ‚Äî –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, tier-dependent
2. **SM-contextual KB** ‚Äî –≤–Ω—É—Ç—Ä–∏ reply-—Å—Ç–µ–π—Ç–æ–≤: Row 1 = –¥–µ–π—Å—Ç–≤–∏—è, Row 2 = `[üè† –ú–µ–Ω—é] [‚öôÔ∏è]`

**mode_select layouts:**

```
T1: [üìö –ú–∞—Ä–∞—Ñ–æ–Ω] [üß™ –¢–µ—Å—Ç]     / [üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å] [‚öôÔ∏è]
T2: [üìñ –õ–µ–Ω—Ç–∞]   [üìö –ú–∞—Ä–∞—Ñ–æ–Ω]  / [üìä –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å] [‚öôÔ∏è]
T3: [üìñ –õ–µ–Ω—Ç–∞]   [ü§ñ Twin]     / [üìä –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ]   [‚öôÔ∏è]
T4: [üìã –ú–æ–π –ø–ª–∞–Ω] [ü§ñ Twin]    / [üìä –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ]   [‚öôÔ∏è]
```

**Tier detection (behavioral):** T1=default, T2=marathon_completed, T3=marathon+DT, T5=DEVELOPER_CHAT_ID

**–ü—Ä–∞–≤–∏–ª–∞:**
- ‚öôÔ∏è = universal settings (Language first, Profile link)
- SM –ù–ï —É–¥–∞–ª—è–µ—Ç KB, –∞ –ó–ê–ú–ï–ù–Ø–ï–¢ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é
- ¬´–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å¬ª (T1-T2) ‚Üí ¬´–ú–æ–∏ –¥–∞–Ω–Ω—ã–µ¬ª (T3+)
- T5 = dev-commands + settings + help (–ù–ï –Ω–∞—Å–ª–µ–¥—É–µ—Ç T4)
- Menu ‚ò∞ per-user —á–µ—Ä–µ–∑ `BotCommandScopeChat`
- –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –ª—é–±–æ–º —Ç–∏—Ä–µ (–≤–∏–¥–∏–º–æ—Å—Ç—å ‚â† –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)

---

## 13. –î–∞–Ω–Ω—ã–µ: schedule_time –∏ marathon_content

### schedule_time ‚Äî —Å—Ç—Ä–æ–≥–æ HH:MM (zero-padded)

Scheduler —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `schedule_time = f"{hour:02d}:{minute:02d}"` (exact match). –î–∞–Ω–Ω—ã–µ –±–µ–∑ –≤–µ–¥—É—â–µ–≥–æ –Ω—É–ª—è (`'7:30'` –≤–º–µ—Å—Ç–æ `'07:30'`) ‚Üí silent failure (0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –Ω–µ—Ç –æ—à–∏–±–∫–∏).

**–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –∑–∞–ø–∏—Å–∏:** `zfill(5)` –≤ `update_intern()`, `settings.py`, `profile.py`. Integrity check: `_check_schedule_integrity()` –≤ `core/scheduler.py`, –µ–∂–µ–¥–Ω–µ–≤–Ω–æ 08:00 MSK.

### marathon_content.status ‚Äî —Å–µ–º–∞–Ω—Ç–∏–∫–∞

| DB status | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö—Ç–æ —Å—Ç–∞–≤–∏—Ç |
|-----------|---------|-----------|
| `pending` | –ö–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–Ω–µ –æ—Ç–∫—Ä—ã–ª** | pre-gen (insert) |
| `delivered` | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–æ—Ç–∫—Ä—ã–ª** —É—Ä–æ–∫ | `mark_content_delivered()` –≤ lesson.py |

`/delivery` dev-–∫–æ–º–∞–Ω–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç—É —Ä–∞–∑–Ω–∏—Ü—É: üü¢ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ / üü° –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –Ω–µ –æ—Ç–∫—Ä—ã—Ç.

### Catch-up (–Ω–∞–≥–æ–Ω—è—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π —É—Ä–æ–∫)

- –ï—Å–ª–∏ `topic['day'] < marathon_day` ‚Üí catch-up notification (–≤–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ).
- –ü–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–≥–æ ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π —É—Ä–æ–∫ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –ª–µ—Ç—É –ø–æ –∫–Ω–æ–ø–∫–µ).
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: **max 1 –¥–µ–Ω—å** catch-up. `MAX_TOPICS_PER_DAY = 4` (2 yesterday + 2 today).

---

## SOTA: Context Engineering (DP.SOTA.002)

> –ë–æ—Ç ‚Äî surface view –Ω–∞–¥ Pack –∏ DDT. –ö–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞ = –ø—Ä–æ–µ–∫—Ü–∏—è, –Ω–µ –∫–æ–ø–∏—è.

- –ö–∞–∂–¥—ã–π state machine state = bounded context —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- –û—Ç–≤–µ—Ç—ã –±–æ—Ç–∞ = view over DDT/Pack, –Ω–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–Ω–∞–Ω–∏–π
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ state ‚Üí –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å: —á—Ç–æ –≤ always-in-context? —á—Ç–æ on-demand?
- MCP tools = select-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è: –∞–≥–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∑–∞–¥–∞—á–∏
