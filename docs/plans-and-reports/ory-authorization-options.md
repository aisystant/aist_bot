# Варианты авторизации бота через Ory для Digital Twin MCP

> Дата: 2026-02-03
> Статус: Анализ
> Связано с: Неделя 7.5 — Digital Twin MCP Integration

---

## Контекст

Digital Twin MCP Server требует авторизации пользователей через Ory (OIDC/OAuth2). Telegram-бот — это серверное приложение без браузера, что создаёт особые требования к выбору OAuth2 flow.

### Ограничения

1. **Бот не имеет браузера** — нельзя показать форму логина напрямую
2. **Telegram WebView ограничен** — не все OAuth flows работают корректно
3. **Пользователи на мобильных устройствах** — переключение между приложениями неудобно
4. **Безопасность** — токены должны храниться защищённо

---

## Вариант 1: Authorization Code Flow с PKCE

### Описание

Классический OAuth2 flow с расширением PKCE (Proof Key for Code Exchange) для защиты от перехвата authorization code.

### Последовательность действий

```
1. Пользователь отправляет /connect
2. Бот генерирует:
   - code_verifier (случайная строка 43-128 символов)
   - code_challenge = BASE64URL(SHA256(code_verifier))
   - state = telegram_user_id + random_nonce
3. Бот сохраняет code_verifier в Redis/DB с TTL 10 минут
4. Бот отправляет пользователю ссылку на авторизацию
5. Пользователь открывает ссылку в браузере
6. Ory показывает форму логина/регистрации
7. Пользователь вводит учётные данные
8. Ory редиректит на callback URL бота с параметрами:
   - code (authorization code)
   - state (для верификации)
9. Webhook бота получает запрос
10. Бот проверяет state, извлекает code_verifier
11. Бот обменивает code + code_verifier на токены
12. Бот сохраняет access_token и refresh_token
13. Бот уведомляет пользователя об успешной авторизации
```

### Требования к инфраструктуре

| Компонент | Описание |
|-----------|----------|
| Веб-сервер | Endpoint для callback (HTTPS) |
| Домен | bot.aisystant.com или аналогичный |
| SSL сертификат | Let's Encrypt или managed |
| Redis/DB | Хранение code_verifier и токенов |

### Параметры авторизации

| Параметр | Значение |
|----------|----------|
| Authorization endpoint | `https://auth.aisystant.com/oauth2/auth` |
| Token endpoint | `https://auth.aisystant.com/oauth2/token` |
| Redirect URI | `https://bot.aisystant.com/auth/callback` |
| Client ID | `aist_bot` |
| Response type | `code` |
| Scope | `openid profile digital_twin` |
| Code challenge method | `S256` |

### Преимущества

1. **Стандартный протокол** — широко поддерживается, хорошо документирован
2. **PKCE защита** — невозможен перехват authorization code
3. **Refresh tokens** — автоматическое обновление сессии
4. **Полный контроль** — можно запрашивать любые scopes

### Недостатки

1. **Требуется веб-сервер** — дополнительный компонент инфраструктуры
2. **Переход в браузер** — разрывает UX в Telegram
3. **Мобильные пользователи** — переключение между приложениями
4. **Сложность реализации** — два компонента (бот + webhook)

### Оценка

| Критерий | Оценка (1-5) |
|----------|--------------|
| Безопасность | 5 |
| Простота реализации | 2 |
| Пользовательский опыт | 3 |
| Требования к инфраструктуре | 2 |
| **Итого** | **3.0** |

---

## Вариант 2: Device Authorization Flow (RFC 8628) — РЕКОМЕНДУЕМЫЙ

### Описание

OAuth2 расширение, разработанное специально для устройств с ограниченным вводом (Smart TV, CLI приложения, IoT). Пользователь авторизуется на отдельном устройстве, вводя короткий код.

### Последовательность действий

```
1. Пользователь отправляет /connect
2. Бот запрашивает device code у Ory:
   POST /oauth2/device/auth
   - client_id
   - scope
3. Ory возвращает:
   - device_code (длинный, для бота)
   - user_code (короткий, 8 символов, для пользователя)
   - verification_uri (URL для ввода кода)
   - verification_uri_complete (URL с кодом в параметре)
   - expires_in (время жизни кода, обычно 1800 секунд)
   - interval (интервал polling, обычно 5 секунд)
4. Бот показывает пользователю:
   - URL для авторизации
   - Код для ввода
   - Кнопку с полным URL (для удобства)
5. Пользователь открывает URL в любом браузере
6. Пользователь вводит user_code (или URL уже содержит его)
7. Ory показывает форму логина
8. Пользователь авторизуется
9. Тем временем бот опрашивает Ory:
   POST /oauth2/token
   - grant_type=urn:ietf:params:oauth:grant-type:device_code
   - device_code
   - client_id
10. Ory отвечает:
    - authorization_pending — продолжаем ждать
    - slow_down — увеличиваем интервал
    - access_denied — пользователь отказался
    - expired_token — время истекло
    - access_token + refresh_token — успех!
11. Бот получает токены и уведомляет пользователя
```

### Требования к инфраструктуре

| Компонент | Описание |
|-----------|----------|
| Ory с Device Flow | Версия 1.10+ с включённым device_authorization |
| Redis/DB | Хранение device_code и токенов |

**Не требуется:** веб-сервер, публичный домен, SSL сертификат для callback

### Параметры авторизации

| Параметр | Значение |
|----------|----------|
| Device authorization endpoint | `https://auth.aisystant.com/oauth2/device/auth` |
| Token endpoint | `https://auth.aisystant.com/oauth2/token` |
| Client ID | `aist_bot` |
| Grant type | `urn:ietf:params:oauth:grant-type:device_code` |
| Scope | `openid profile digital_twin` |

### Формат user_code

Ory генерирует коды в формате `XXXX-XXXX` (8 символов, разделённых дефисом). Используются только символы, которые сложно спутать:

```
BCDFGHJKLMNPQRSTVWXZ (без гласных, без 0, O, I, 1, L)
```

### Преимущества

1. **Не нужен callback URL** — бот опрашивает Ory напрямую
2. **Простая архитектура** — только один компонент (бот)
3. **Отличный UX** — короткий код легко ввести
4. **Кроссплатформенность** — работает на любом устройстве
5. **Стандарт RFC 8628** — хорошо документирован

### Недостатки

1. **Polling нагружает сервер** — запросы каждые 5 секунд
2. **Требует поддержки Ory** — не все версии/конфигурации поддерживают
3. **Timeout** — если пользователь не успел, нужно начинать заново

### Проверка поддержки Ory

```bash
curl https://auth.aisystant.com/.well-known/openid-configuration | jq .device_authorization_endpoint
```

Если возвращается URL — Device Flow поддерживается.

### Конфигурация Ory Hydra

```yaml
# ory/hydra.yml
oauth2:
  device_authorization:
    enabled: true
    # Опционально:
    # user_code_length: 8
    # user_code_charset: "BCDFGHJKLMNPQRSTVWXZ"
```

### Оценка

| Критерий | Оценка (1-5) |
|----------|--------------|
| Безопасность | 5 |
| Простота реализации | 4 |
| Пользовательский опыт | 4 |
| Требования к инфраструктуре | 5 |
| **Итого** | **4.5** |

---

## Вариант 3: Telegram Login Widget + Ory

### Описание

Использование встроенного механизма Telegram Login Widget на веб-странице Aisystant. Telegram предоставляет подписанные данные пользователя, которые Ory может использовать для создания/связывания аккаунта.

### Последовательность действий

```
1. Пользователь отправляет /connect
2. Бот отправляет ссылку на веб-страницу Aisystant
3. Пользователь открывает страницу
4. Страница показывает Telegram Login Widget
5. Пользователь нажимает "Войти через Telegram"
6. Telegram показывает подтверждение (имя, фото, телефон)
7. Пользователь подтверждает
8. Telegram редиректит на callback с подписанными данными:
   - id (Telegram user ID)
   - first_name, last_name
   - username
   - photo_url
   - auth_date
   - hash (HMAC-SHA-256 подпись)
9. Веб-сервер проверяет подпись
10. Веб-сервер создаёт/находит пользователя в Ory
11. Веб-сервер генерирует access_token
12. Веб-сервер уведомляет бота через webhook
13. Бот сохраняет токен и уведомляет пользователя
```

### Требования к инфраструктуре

| Компонент | Описание |
|-----------|----------|
| Веб-приложение | Страница с Telegram Login Widget |
| Домен | Должен быть зарегистрирован в @BotFather |
| Ory Identity | Для управления пользователями |
| Webhook | Уведомление бота о успешной авторизации |

### Настройка Telegram Login Widget

1. Зарегистрировать домен в @BotFather:
   ```
   /setdomain
   @your_bot
   aisystant.com
   ```

2. Добавить виджет на страницу:
   ```html
   <script async src="https://telegram.org/js/telegram-widget.js?22"
     data-telegram-login="AistBot"
     data-size="large"
     data-auth-url="https://aisystant.com/auth/telegram/callback"
     data-request-access="write">
   </script>
   ```

### Преимущества

1. **Нативный Telegram UX** — знакомый пользователям интерфейс
2. **Один клик** — минимум действий для авторизации
3. **Верифицированные данные** — Telegram гарантирует подлинность
4. **Не нужен пароль** — пользователь не вводит учётные данные

### Недостатки

1. **Требуется веб-приложение** — дополнительная инфраструктура
2. **Связывание аккаунтов** — нужна логика merge/link в Ory
3. **Ограниченные данные** — только Telegram profile
4. **Зависимость от Telegram** — если API изменится

### Оценка

| Критерий | Оценка (1-5) |
|----------|--------------|
| Безопасность | 4 |
| Простота реализации | 2 |
| Пользовательский опыт | 5 |
| Требования к инфраструктуре | 2 |
| **Итого** | **3.25** |

---

## Вариант 4: Magic Link через Email

### Описание

Пользователь получает ссылку для авторизации на email. После перехода по ссылке сессия автоматически активируется.

### Последовательность действий

```
1. Пользователь отправляет /connect
2. Бот запрашивает email
3. Пользователь вводит email
4. Бот запрашивает magic link у Ory:
   POST /self-service/login/api
   - method: link
   - email
5. Ory отправляет email со ссылкой
6. Пользователь открывает email и нажимает ссылку
7. Ory активирует сессию
8. Бот получает уведомление (webhook или polling)
9. Бот сохраняет токен и уведомляет пользователя
```

### Требования к инфраструктуре

| Компонент | Описание |
|-----------|----------|
| Ory с Passwordless | Включён login method: link |
| Email провайдер | SMTP или API (SendGrid, Mailgun) |
| Webhook | Уведомление бота о успешной авторизации |

### Преимущества

1. **Знакомый UX** — многие сервисы используют magic links
2. **Без пароля** — меньше friction
3. **Кроссплатформенность** — работает везде, где есть email

### Недостатки

1. **Требуется email** — не у всех пользователей есть/хотят указывать
2. **Задержка доставки** — email может идти долго
3. **Spam фильтры** — письмо может попасть в спам
4. **Безопасность email** — если взломан email, взломан аккаунт

### Оценка

| Критерий | Оценка (1-5) |
|----------|--------------|
| Безопасность | 3 |
| Простота реализации | 3 |
| Пользовательский опыт | 3 |
| Требования к инфраструктуре | 3 |
| **Итого** | **3.0** |

---

## Сравнительная таблица

| Критерий | Auth Code + PKCE | Device Flow | TG Widget | Magic Link |
|----------|------------------|-------------|-----------|------------|
| Нужен callback URL | Да | Нет | Да | Да |
| Нужен веб-сервер | Да | Нет | Да | Нет |
| Пользователь вводит пароль | Да | Да | Нет | Нет |
| Работает офлайн | Нет | Нет | Нет | Нет |
| Поддержка Ory | Да | 1.10+ | Custom | Да |
| Время реализации | 2-3 дня | 1 день | 3-5 дней | 2 дня |
| **Рекомендация** | Backup | **Primary** | Future | Fallback |

---

## Рекомендации

### Для MVP (сейчас)

**Device Authorization Flow** — оптимальный выбор:

1. Минимальные требования к инфраструктуре
2. Простая реализация
3. Хороший UX
4. Стандартный протокол

### Для Production (после Mini App)

**Authorization Code Flow через Mini App**:

1. Mini App открывается в Telegram WebView
2. Пользователь авторизуется внутри приложения
3. Токены передаются через Telegram WebApp API
4. Нет переключения между приложениями

### Fallback стратегия

```
1. Попробовать Device Flow
   ↓ (если Ory не поддерживает)
2. Использовать Authorization Code + PKCE
   ↓ (если нет веб-сервера)
3. Magic Link через email
```

---

## Следующие шаги

1. **Проверить поддержку Device Flow в Ory**
   ```bash
   curl https://auth.aisystant.com/.well-known/openid-configuration
   ```

2. **Зарегистрировать OAuth2 клиент**
   - client_id: `aist_bot`
   - grant_types: `device_code`, `refresh_token`
   - scopes: `openid`, `profile`, `digital_twin`

3. **Реализовать выбранный flow в боте**
   - Команда `/connect`
   - Хранение токенов
   - Middleware для refresh

4. **Интегрировать с Digital Twin клиентом**
   - Передача access_token в запросах
   - Обработка 401 ошибок

---

## Ссылки

- [RFC 8628 — OAuth 2.0 Device Authorization Grant](https://datatracker.ietf.org/doc/html/rfc8628)
- [Ory Hydra — Device Authorization](https://www.ory.sh/docs/hydra/guides/oauth2-grant-device-authorization)
- [Telegram Login Widget](https://core.telegram.org/widgets/login)
- [PKCE — RFC 7636](https://datatracker.ietf.org/doc/html/rfc7636)
