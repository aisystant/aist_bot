---
type: mapstrategic
status: draft
created: 2026-02-09
updated: 2026-02-09
---

# Карта стратегии: AIST Bot → Тонкий клиент

> **Тип:** Downstream/instrument → Слой 1 (Интерфейс) в [архитектуре платформы](../DS-my-strategy/inbox/platform_architecture_v2.md)
>
> **Целевое состояние:** Бот = тонкий клиент без бизнес-логики. Вся логика — в агентах (слой 2) и MCP (слой 3).

---

## 1. Текущее состояние (As-Is)

**Монолит:** `bot.py` на 3800+ строк содержит:
- Legacy-код (прямые хендлеры aiogram)
- State Machine (states/, transitions.yaml)
- Бизнес-логику марафона, ленты, прогресса
- Роутинг, привязанный к марафону (все entry points → Marathon)
- Планировщик (scheduler), работающий только с марафоном

**Проблемы:**
- Добавление нового режима (Лента) не обновило entry points (/learn, scheduler, callbacks)
- Нет разделения «что показывать» и «какая логика» — UI и бизнес-логика в одном файле
- Нет интеграций (GitHub, ЦД, Стратег) — всё внутри бота
- Каждая новая фича = ещё больше кода в bot.py

---

## 2. Целевое состояние (To-Be)

```
Бот (тонкий клиент)          Агенты              MCP                Хранилище
┌──────────────────┐   ┌─────────────────┐   ┌──────────────┐   ┌─────────────┐
│ Диспетчер        │──▶│ Проводник       │──▶│ guides-mcp   │──▶│ GitHub      │
│ (команды,        │   │ Стратег         │   │ digital-twin │   │ Neon PG     │
│  префиксы,       │   │ Консультант     │   │ user-repos   │   │ (pgvector)  │
│  State Machine)  │   │ ProgressAnalyst │   │ fsm-mcp      │   │             │
│                  │   │ RhythmKeeper    │   │ pack-MCP'ы   │   │             │
│ Форматирование   │   │                 │   │              │   │             │
│ для Telegram     │   │                 │   │              │   │             │
└──────────────────┘   └─────────────────┘   └──────────────┘   └─────────────┘
     Слой 1                  Слой 2               Слой 3             Слой 4
```

**Принцип:** Бот знает только «какого агента вызвать». Агент знает логику. MCP знает данные.

---

## 3. Фазы эволюции

### Phase 0: Стабилизация + Mode-aware Routing (1-2 недели)

> **Цель:** Бот готов к марафону 14 февраля. Оба режима (Марафон + Лента) работают корректно.
> **Дедлайн:** 14 февраля 2026

**Что делаем:**
1. **Mode-aware routing** — /learn, callback `learn`, scheduler проверяют `user.mode` и направляют в нужный стейт (Marathon или Feed)
2. **Fix digest progress** — убрать hardcoded "Возвращайтесь завтра" из feed progress
3. **Fix come_back transition** — после "возвращайтесь завтра" не показывать меню выбора режима, оставлять в текущем режиме
4. **Mode-aware scheduler** — уведомления для обоих режимов
5. **Smoke test** — ручное прохождение Марафон (Урок→Вопрос→Бонус→Задание) + Лента (Темы→Дайджест→Фиксация)

**Архитектурный задел:**
- Выделить функцию `get_user_mode_state(user) → str` — единая точка определения стейта по режиму
- Подготовить место для диспетчера (отдельный модуль `core/dispatcher.py`)

**Результат:** Бот стабильно работает в обоих режимах. Марафон можно запускать.

---

### Phase 1: Диспетчер + Интеграции (2-3 недели)

> **Цель:** Чистый роутинг, глобальные команды, первые интеграции.
> **Дедлайн:** ~1 марта 2026

**Что делаем:**
1. **Извлечь диспетчер** из bot.py в `core/dispatcher.py`:
   ```python
   async def dispatch(message, user):
       if text.startswith('.'):     # Заметка → MCP
       if text.startswith('?'):     # Консультация → Агент
       if text in COMMANDS:         # Команда → Агент/стейт
       else:                        # State Machine
   ```
2. **Глобальные префиксы** `.` и `?` работают из любого стейта
3. **Подключение digital-twin-mcp** — чтение/запись прогресса
4. **`.` заметка** → коммит в личное репо через GitHub API
5. **`?` консультация** → прямой вызов guides-mcp (без классификации уровня)
6. **Новые команды** — `/rp`, `/report`, `/twin` (пока заглушки или прямые MCP-вызовы)

**Архитектурный задел:**
- `core/dispatcher.py` — центральный роутер
- `integrations/mcp/` — клиенты для MCP-серверов
- `integrations/agents/` — клиенты для агентов (пока заглушки)

**Результат:** bot.py уменьшается на ~40%. Появляются первые интеграции. Пользователь может делать заметки и задавать вопросы из любого стейта.

---

### Phase 2: Агенты (3-4 недели)

> **Цель:** Бизнес-логика переезжает в агентов. Бот становится UI-прослойкой.
> **Дедлайн:** ~1 апреля 2026

**Что делаем:**
1. **Агент Стратег** — отдельный сервис (HTTP API):
   - `/rp` → Стратег.weekly_plan
   - `/report` → Стратег.daily_report
   - Вечерний отчёт по расписанию
2. **Агент Консультант** — классификация уровня вопроса (FPF/SPF/Pack):
   - `?` → Консультант, который сам выбирает БЗ
3. **MCP Registry** (yaml) — реестр доступных MCP
4. **GitHub OAuth** — подключение личных репо
5. **Рефакторинг scheduler** — агенты вызываются по расписанию, не бот

**Архитектурный задел:**
- Агенты = отдельные репо с config.yaml
- Бот вызывает агентов через единый интерфейс
- Scheduler переезжает в агентов (бот только доставляет сообщения)

**Результат:** bot.py — чистый UI-слой. Логика в агентах. Заметки и консультации через MCP.

---

### Phase 3: Тонкий клиент + Масштаб (ongoing)

> **Цель:** Бот = один из многих интерфейсов. Те же агенты доступны из LMS, OpenAI, Claude.
> **Горизонт:** Q2-Q3 2026

**Что делаем:**
1. **Telegram WebApp (Mini App)** для сложных UI:
   - **Дашборд пользователя:** визуальный прогресс, графики активности, heatmap-календарь, сравнение с другими
   - **Управление подключениями:** GitHub OAuth, выбор репо, настройки интеграций
   - Технология: React + Telegram WebApp SDK, данные через API бота
   - ArchGate-решение (14 фев 2026): текстовый /progress — Phase 1, Mini App — Phase 3 (после стабилизации данных и 50+ пользователей)
2. **Агенты доступны из LMS** — те же API
3. **Новые агенты** по шаблону: ProgressAnalyst, RhythmKeeper, Проводник
4. **10+ MCP** в реестре
5. **Sub-agents** — агенты вызывают агентов
6. **OAuth через Ory Kratos** — единый ID

**Результат:** Полноценная 4-слойная архитектура. Бот — один из интерфейсов.

---

## 4. Матрица: что где живёт (по фазам)

| Компонент | Phase 0 (сейчас) | Phase 1 | Phase 2 | Phase 3 |
|-----------|----------|---------|---------|---------|
| **Роутинг** | bot.py (хаос) | core/dispatcher.py | dispatcher.py | shared lib |
| **Марафон логика** | states/ + bot.py | states/ | Проводник (агент) | Проводник |
| **Лента логика** | states/ + bot.py | states/ | states/ → агент | Проводник |
| **Консультация** | простой промпт в bot.py | `?` → guides-mcp | `?` → Консультант | Консультант |
| **Заметки** | нет | `.` → GitHub API | `.` → user-repos MCP | user-repos MCP |
| **Стратег** | нет | заглушка | отдельный сервис | отдельный сервис |
| **Прогресс** | utility/progress.py | + digital-twin-mcp | ProgressAnalyst | ProgressAnalyst |
| **Уведомления** | scheduler в bot.py | scheduler + mode-aware | Агенты по расписанию | RhythmKeeper |
| **Хранение** | MongoDB | Neon PG + MCP | MCP → Neon PG | MCP → Neon PG |

---

## 5. Критерии перехода между фазами

### Phase 0 → Phase 1
- [ ] Оба режима (Марафон + Лента) работают без багов
- [ ] Марафон успешно проведён (14 фев)
- [ ] /learn, scheduler, callbacks — mode-aware
- [ ] Smoke test пройден

### Phase 1 → Phase 2
- [ ] Диспетчер выделен в отдельный модуль
- [ ] `.` и `?` работают из любого стейта
- [ ] digital-twin-mcp подключён
- [ ] bot.py < 2000 строк

### Phase 2 → Phase 3
- [ ] Стратег и Консультант — отдельные сервисы
- [ ] MCP Registry работает
- [ ] bot.py < 500 строк (чистый UI)
- [ ] Минимум 5 MCP подключено

---

## 6. Риски и mitigation

| Риск | Вероятность | Влияние | Mitigation |
|------|------------|---------|------------|
| Марафон 14 фев — баги | Высокая | Критическое | Phase 0 фокус, smoke test |
| Рефакторинг ломает работающее | Средняя | Высокое | Feature flags, параллельная работа old/new |
| MCP-серверы не готовы вовремя | Средняя | Среднее | Заглушки, прямые API-вызовы пока нет MCP |
| Сложность растёт быстрее, чем упрощение | Низкая | Высокое | Строгое разделение слоёв с Phase 1 |

---

---

## 7. Бэклог идей (из Note-Review)

> Добавлено: 2026-02-14 (Note-Review)

| Идея | Источник | Фаза |
|------|----------|------|
| ~~Интеграция с systemsworld.club~~ ✅ WP-53 Phase 1-3 done (21 фев) | заметка 14 фев 09:22 | ✅ Done |
| **Мультиплатформенная публикация** — Content Adapter Layer: source post → Claude API adapts per platform (Twitter thread/280, LinkedIn prof tone, TG channel concise, VK long-read) → direct platform APIs. target в frontmatter = список платформ. АрхГейт: 8.3/10 (Вариант C). НЕ использовать Postiz/n8n (6.5/10 — тяжёлые middlemen). | сессия WP-53, 21 фев | Phase 3 |
| Стратег в боте — диалог + запись в DS-my-strategy | заметка 14 фев 09:22 | Phase 2 |
| Питч для инвесторов (развитие бота) | заметка 14 фев 09:22 | Phase 3 |
| **MCP-сервер Railway** — обёртка Railway API для логов, деплоев, метрик. Claude Code получает логи как tool (Context Engineering). Паттерн переносим на любой PaaS → генеративность для шаблона экзокортекса (T3). ArchGate: выигрывает по эволюционируемости, масштабируемости, генеративности, современности vs прямой CLI | сессия 16 фев, ArchGate-оценка | Phase 2 |
| **Publisher: OAuth вместо PAT** — GitHubContentClient (Publisher, AutoFix) использует `GITHUB_BOT_PAT` env var. Для шаблонных пользователей нужен self-service: владелец бота подключает GitHub через `/github` OAuth → Publisher берёт токен из `github_connections` DB вместо env var. Fallback: env var (backward compat). Паттерн уже работает в GitHubStrategyClient. АрхГейт: 8.8/10 (обучаемость 9, генеративность 8 — шаблонные пользователи не трогают env vars). | сессия 21 фев | Phase 2 |
| **Тест владения Принципами (Principles Proficiency Test)** — адаптивный бот-тест по аналогии с IELTS placement test. Тестирует каждый ZP-принцип независимо (3-5 вопросов), определяет глубину 0-5 (Bloom), выдаёт векторный профиль `{ZP.1:3, ZP.2:1, ...}`. Источник: EDU.WP.005 (Diagnostic Assessment), рубрика: can-do из EDU.MAP.001. Формат: `/test` → адаптивный диалог → результат = профиль + bottleneck + рекомендация стратегии. Данные: в digital-twin (профиль → EDU.WP.004 Learning Progression Map). | сессия 21 фев (WP-50) | Phase 2-3 |

---

## 8. Открытые вопросы (из совещания с Архитектором 19 фев)

> Решения, которые затрагивают бот, но ещё не имеют конкретного ответа.

| Вопрос | Контекст | Статус |
|--------|----------|--------|
| **C5: Изоляция данных** | Как защитить данные одного пользователя от другого в multi-tenant (Neon RLS? schemas? отдельные DB?) | **Открыт** — требуется решение |
| **B1-B8: Архитектура тиров T1→T4** | Как бот меняется при переходе пользователя между тирами? Где хранится прогресс? Как интегрироваться с Aisystant? | **Открыт** — ждём прояснения платформы Андрея |
| **Конфигурация агентов** | Каждый агент = конфигурация (может/не может). Взаимодействие через Discourse | **Открыт** — Андрей исследует Discourse |
| **ORY + репликация** | Хранение ORY за границей, репликация с Пашей | **Открыт** — на Андрее |

> Полный документ: [architect-questions-2026-02-20.md](https://github.com/aisystant/DS-ecosystem-development/blob/main/0.OPS/0.9.Inbox/architect-questions-2026-02-20.md)

---

*Последнее обновление: 2026-02-21 (+ Principles Proficiency Test)*
