"""
ะะฐะปะธะดะฐัะพั ัะพัะผัะปะธัะพะฒะบะธ ัะฐะฑะพัะตะณะพ ะฟัะพะดัะบัะฐ (DS-evaluator-agent runtime).

ะะฒััััะพะฒะฝะตะฒะฐั ะฟัะพะฒะตัะบะฐ:
- Level 1: regex + ััะพะฟ-ัะปะพะฒะฐ (0 ะผั, ะฑะตะท LLM)
- Level 2: Claude Haiku (fallback ะดะปั ะฝะตะพะดะฝะพะทะฝะฐัะฝัั ัะปััะฐะตะฒ, <2 ัะตะบ)

ะัะฐะฒะธะปะพ: ะะ ะฝะฐัะธะฝะฐะตััั ั ัััะตััะฒะธัะตะปัะฝะพะณะพ, ะพะฑะพะทะฝะฐัะฐััะตะณะพ ะะะะฃะะะะข, ะะะฉะฌ
ะธะปะธ ะกะะกะขะะฏะะะ ะกะะกะขะะะซ. ะะ ั ะณะปะฐะณะพะปะฐ, ะฟัะพัะตััะฐ, ะผะตัะพะดะฐ ะธะปะธ ะถะตะปะฐะฝะธั.
ะัะณะปะฐะณะพะปัะฝัะต ัััะตััะฒะธัะตะปัะฝัะต-ะฟัะพัะตััั (ะฐะฝะฐะปะธะท, ะธััะปะตะดะพะฒะฐะฝะธะต, ะพะฑะทะพั,
ะดะธะฐะณะฝะพััะธะบะฐ, ััะฐะฒะฝะตะฝะธะต) โ ะะะะะะฉะะะซ ะบะฐะบ ะฝะฐัะฐะปะพ ะะ.

ะัะพะผะฟั: DS-evaluator-agent/prompts/wp-validate.md
"""

import re
from typing import Optional

from config import get_logger, CLAUDE_MODEL_HAIKU

logger = get_logger(__name__)


# โโโ Level 1: Regex-ะฟัะพะฒะตัะบะฐ โโโ

# ะกัะพะฟ-ัะปะพะฒะฐ ะฒ ะฝะฐัะฐะปะต ัะพัะผัะปะธัะพะฒะบะธ (ะฟัะพัะตัั, ะถะตะปะฐะฝะธะต, ะดะตะนััะฒะธะต)
BAD_STARTS_RE = re.compile(
    r'^(ัะพัั|ะฝะฐะดะพ|ะฝัะถะฝะพ|ัะดะตะปะฐัั|ะดะตะปะฐัั|ัะฐะฑะพัะฐ\b|ะฟัะพัะตัั\b|ะผะตัะพะด\b|ัะฟะพัะพะฑ\b|ะทะฐะดะฐัะฐ\b'
    r'|ะฟะพะฟัะพะฑะพะฒะฐัั|ะฟะพะฟััะฐัััั|ะฝะฐัะฐัั|ะฟัะพะดะพะปะถะธัั'
    r'|ั\s|ะผะฝะต\s|ะผะพะน\s|ะผะพั\s|ะผะพั\s)',
    re.IGNORECASE,
)

# ะะฝัะธะฝะธัะธะฒ: ะฟะตัะฒะพะต ัะปะพะฒะพ ะพะบะฐะฝัะธะฒะฐะตััั ะฝะฐ ะณะปะฐะณะพะปัะฝัะต ััััะธะบัั
VERB_INFINITIVE_RE = re.compile(
    r'^[ะฐ-ััะ-ะฏะ]+?(ะฐัั|ััั|ะธัั|ะตัั|ััั|ััั|ัั|ัะธ|ััะธ|ะทัะธ|ัััั|ัะธัั)\s',
    re.IGNORECASE,
)

# ะะดะธะฝะพัะฝัะน ะธะฝัะธะฝะธัะธะฒ (ะฑะตะท ะฟัะพะฑะตะปะฐ ะฟะพัะปะต โ ะฒัั ัะพัะผัะปะธัะพะฒะบะฐ ะพะดะฝะพ ัะปะพะฒะพ-ะณะปะฐะณะพะป)
VERB_SINGLE_RE = re.compile(
    r'^[ะฐ-ััะ-ะฏะ]+?(ะฐัั|ััั|ะธัั|ะตัั|ััั|ััั|ัั|ัะธ|ััะธ|ะทัะธ|ัััั|ัะธัั)$',
    re.IGNORECASE,
)

# ะะตะปัะน ัะฟะธัะพะบ: ะฐััะตัะฐะบัะฝัะต ัััะตััะฒะธัะตะปัะฝัะต ะฒ ะฝะฐัะฐะปะต (ะดะพะบัะผะตะฝั, ะฒะตัั, ัะพััะพัะฝะธะต)
GOOD_STARTS = {
    'ัะตะบ-ะปะธัั', 'ัะฟะธัะพะบ', 'ัะฐะฑะปะธัะฐ', 'ััะตะผะฐ', 'ะฟะปะฐะฝ', 'ัะตะบัั', 'ะฟะพัั',
    'ะพะฟะธัะฐะฝะธะต', 'ะพะฟัะตะดะตะปะตะฝะธะต', 'ัะพัะผัะปะธัะพะฒะบะฐ', 'ะบะฐััะฐ', 'ะผะฐััะธัะฐ',
    'ะดะธะฐะณัะฐะผะผะฐ', 'ะฝะฐะฑะพั', 'ัะตะตััั', 'ะพัััั',
    'ะฟัะพัะพะบะพะป', 'ัะฐะฑะปะพะฝ', 'ัะตัะฝะพะฒะธะบ', 'ะทะฐะผะตัะบะฐ', 'ะบะพะฝัะฟะตะบั', 'ะฒัะฟะธัะบะฐ',
    'ะฟะตัะตัะตะฝั', 'ะบะปะฐััะธัะธะบะฐัะธั', 'ะฟัะพะณะฝะพะท',
}

# ะกัะพะฟ-ัะปะพะฒะฐ: ะพัะณะปะฐะณะพะปัะฝัะต ัััะตััะฒะธัะตะปัะฝัะต-ะฟัะพัะตััั (ะะ ะฐััะตัะฐะบัั).
# ะะฐัะฐะปะพ ั ััะธั ัะปะพะฒ โ Level 2 ะฝะต ัะฟะฐััั, ััะฐะทั bad.
BAD_PROCESS_NOUNS = {
    'ะฐะฝะฐะปะธะท', 'ะธััะปะตะดะพะฒะฐะฝะธะต', 'ะพะฑะทะพั', 'ะดะธะฐะณะฝะพััะธะบะฐ', 'ััะฐะฒะฝะตะฝะธะต',
    'ะพะฑะพะณะฐัะตะฝะธะต', 'ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต', 'ะธะฝัะตะณัะฐัะธั', 'ะฟัะฑะปะธะบะฐัะธั',
    'ัะฐะทะฒััััะฒะฐะฝะธะต', 'ัะพะทะดะฐะฝะธะต', 'ัะฐะทัะฐะฑะพัะบะฐ', 'ะฟัะพะตะบัะธัะพะฒะฐะฝะธะต',
    'ัะตััะธัะพะฒะฐะฝะธะต', 'ะผะพะดะตะปะธัะพะฒะฐะฝะธะต', 'ะพัะตะฝะบะฐ',
}


def _get_first_word(text: str) -> str:
    """ะะทะฒะปะตะบะฐะตั ะฟะตัะฒะพะต ัะปะพะฒะพ ะธะท ัะตะบััะฐ (lowercase)."""
    return text.strip().split()[0].lower() if text.strip() else ""


def validate_formulation_regex(text: str) -> dict:
    """Level 1: ะฑััััะฐั regex-ะฟัะพะฒะตัะบะฐ ัะพัะผัะปะธัะพะฒะบะธ ะะ.

    Returns:
        {"valid": bool, "reason": str, "confident": bool}
        confident=True ะพะทะฝะฐัะฐะตั, ััะพ regex ัะฒะตัะตะฝ ะฒ ัะตะทัะปััะฐัะต.
        confident=False ะพะทะฝะฐัะฐะตั, ััะพ ะฝัะถะตะฝ Level 2 (Claude).
    """
    text = text.strip()
    if not text:
        return {"valid": False, "reason": "empty", "confident": True}

    first_word = _get_first_word(text)

    # ะะตะปัะน ัะฟะธัะพะบ โ ัะพัะฝะพ ัะพัะพัะพ
    if first_word in GOOD_STARTS:
        return {"valid": True, "reason": "good_start", "confident": True}

    # ะัะพัะตััะฝัะต ัััะตััะฒะธัะตะปัะฝัะต โ ัะพัะฝะพ ะฟะปะพัะพ (ะดะพะบัะผะตะฝั, ะฒะตัั, ัะพััะพัะฝะธะต โ ะะ ะฟัะพัะตัั)
    if first_word in BAD_PROCESS_NOUNS:
        return {"valid": False, "reason": "process_noun", "confident": True}

    # ะกัะพะฟ-ัะปะพะฒะฐ โ ัะพัะฝะพ ะฟะปะพัะพ
    if BAD_STARTS_RE.match(text):
        return {"valid": False, "reason": "bad_start", "confident": True}

    # ะะฝัะธะฝะธัะธะฒ โ ัะพัะฝะพ ะฟะปะพัะพ
    if VERB_INFINITIVE_RE.match(text) or VERB_SINGLE_RE.match(text):
        return {"valid": False, "reason": "verb_infinitive", "confident": True}

    # ะัะณะปะฐะณะพะปัะฝัะต ัััะตััะฒะธัะตะปัะฝัะต ั ัะธะฟะธัะฝัะผะธ ััััะธะบัะฐะผะธ โ ัะบะพัะตะต ัะพัะพัะพ
    if re.match(r'^[ะฐ-ััะ-ะฏะ]+?(ะฐะฝะธะต|ะตะฝะธะต|ัะธั|ะบะฐ|ะพััั|ััะฒะพ)\b', text, re.IGNORECASE):
        return {"valid": True, "reason": "deverbal_noun", "confident": True}

    # ะะตะพะดะฝะพะทะฝะฐัะฝะพ โ ะฟะตัะตะดะฐัะผ ะฝะฐ Level 2
    return {"valid": True, "reason": "unknown", "confident": False}


async def validate_formulation_llm(text: str) -> dict:
    """Level 2: Claude ะฟัะพะฒะตัะบะฐ ะดะปั ะฝะตะพะดะฝะพะทะฝะฐัะฝัั ัะปััะฐะตะฒ.

    Returns:
        {"valid": bool, "suggestion": str}
    """
    from clients.claude import claude

    system_prompt = """ะะฟัะตะดะตะปะธ, ัะฒะปัะตััั ะปะธ ัะพัะผัะปะธัะพะฒะบะฐ ัะฐะฑะพัะตะณะพ ะฟัะพะดัะบัะฐ ะบะพััะตะบัะฝะพะน.

ะะะะะะะ: ะะฐะฑะพัะธะน ะฟัะพะดัะบั โ ะผะฐัะตัะธะฐะปัะฝะพ ะทะฐัะธะบัะธัะพะฒะฐะฝะฝัะน ะฐััะตัะฐะบั.
ะคะพัะผัะปะธัะพะฒะบะฐ ะะะะะะ ะฝะฐัะธะฝะฐัััั ั ัััะตััะฒะธัะตะปัะฝะพะณะพ, ะพะฑะพะทะฝะฐัะฐััะตะณะพ ะะะะฃะะะะข, ะะะฉะฌ ะธะปะธ ะกะะกะขะะะฃ ะ ะะะะะะะะะะะะ ะกะะกะขะะฏะะะ.
ะขะตัั: ะผะพะถะฝะพ ะปะธ ััะพ ัะฒะธะดะตัั, ะฟะตัะตะดะฐัั ะธะปะธ ะฟะพะบะฐะทะฐัั?

ะะะะะะฉะะะ ะฝะฐัะธะฝะฐัั ั:
- ะะปะฐะณะพะปะพะฒ: ยซะัะพะฐะฝะฐะปะธะทะธัะพะฒะฐััยป, ยซะกะดะตะปะฐััยป, ยซะะฝะตะดัะธััยป
- ะัะพัะตััะพะฒ: ยซะะฐะฑะพัะฐ ะฝะฐะด...ยป, ยซะัะพัะตัั ะฟัะฑะปะธะบะฐัะธะธยป
- ะะตัะพะดะพะฒ: ยซะะตัะพะด ะฐะฝะฐะปะธะทะฐยป, ยซะกะฟะพัะพะฑ ัะตัะตะฝะธัยป
- ะะตะปะฐะฝะธะน: ยซะฅะพัั ัะดะตะปะฐัั...ยป, ยซะะฐะดะพ...ยป
- ะัะณะปะฐะณะพะปัะฝัั ัััะตััะฒะธัะตะปัะฝัั-ะะะะฆะะกะกะะ: ยซะะฝะฐะปะธะท...ยป, ยซะััะปะตะดะพะฒะฐะฝะธะต...ยป, ยซะะฑะทะพั...ยป, ยซะะธะฐะณะฝะพััะธะบะฐ...ยป, ยซะกัะฐะฒะฝะตะฝะธะต...ยป

ะฅะะะะจะ: ยซะงะตะบ-ะปะธัั ะฟัะธะฒััะตะบยป, ยซะะฟะธัะฐะฝะธะต ัะตะบััะตะณะพ ัะพััะพัะฝะธัยป, ยซะขะฐะฑะปะธัะฐ ัะตะปะตะนยป, ยซะกัะตะผะฐ ะฟัะพัะตััะฐยป, ยซะขะตะบัั ะฟะพััะฐยป
ะะะะฅะ: ยซะะฝะฐะปะธะท ัะฐะทะปะธัะธะนยป, ยซะััะปะตะดะพะฒะฐะฝะธะต ะฟะพะดัะพะดะพะฒยป, ยซะะฑะทะพั ะผะตัะพะดะพะฒยป, ยซะะธะฐะณะฝะพััะธะบะฐ ัะธััะตะผัยป

ะัะฒะตัั ะกะขะะะะ ะฒ ัะพัะผะฐัะต:
VALID: true ะธะปะธ false
SUGGESTION: <ะตัะปะธ false โ ะฟัะตะดะปะพะถะธ ะธัะฟัะฐะฒะปะตะฝะฝัั ัะพัะผัะปะธัะพะฒะบั, ะฝะฐัะธะฝะฐัััััั ั ะดะพะบัะผะตะฝัะฐ/ะฒะตัะธ>"""

    user_prompt = f'ะคะพัะผัะปะธัะพะฒะบะฐ: ยซ{text}ยป'

    try:
        raw = await claude.generate(
            system_prompt=system_prompt,
            user_prompt=user_prompt,
            max_tokens=150,
            model=CLAUDE_MODEL_HAIKU,
        )
        if not raw:
            return {"valid": True, "suggestion": ""}  # ะฟัะธ ะพัะธะฑะบะต โ ะฟัะพะฟััะบะฐะตะผ

        valid = True
        suggestion = ""
        for line in raw.split('\n'):
            line = line.strip()
            if line.startswith('VALID:'):
                valid = 'true' in line.lower()
            elif line.startswith('SUGGESTION:'):
                suggestion = line[11:].strip()

        return {"valid": valid, "suggestion": suggestion}

    except Exception as e:
        logger.error(f"WP validator LLM error: {e}")
        return {"valid": True, "suggestion": ""}  # ะฟัะธ ะพัะธะฑะบะต โ ะฟัะพะฟััะบะฐะตะผ


async def validate_formulation(text: str, use_llm_fallback: bool = True) -> dict:
    """ะะพะปะฝะฐั ะฒะฐะปะธะดะฐัะธั ัะพัะผัะปะธัะพะฒะบะธ ะะ (Level 1 + ะพะฟัะธะพะฝะฐะปัะฝัะน Level 2).

    Args:
        text: ัะพัะผัะปะธัะพะฒะบะฐ ัะฐะฑะพัะตะณะพ ะฟัะพะดัะบัะฐ
        use_llm_fallback: ะธัะฟะพะปัะทะพะฒะฐัั Claude ะดะปั ะฝะตะพะดะฝะพะทะฝะฐัะฝัั ัะปััะฐะตะฒ

    Returns:
        {"valid": bool, "reason": str, "suggestion": str}
    """
    # Level 1: regex
    result = validate_formulation_regex(text)

    if result["confident"]:
        return {
            "valid": result["valid"],
            "reason": result["reason"],
            "suggestion": "",
        }

    # Level 2: Claude (ะตัะปะธ regex ะฝะต ัะฒะตัะตะฝ)
    if use_llm_fallback:
        llm_result = await validate_formulation_llm(text)
        return {
            "valid": llm_result["valid"],
            "reason": "llm_check",
            "suggestion": llm_result.get("suggestion", ""),
        }

    # ะะตะท LLM โ ะฟัะพะฟััะบะฐะตะผ ะฝะตะพะดะฝะพะทะฝะฐัะฝัะต
    return {"valid": True, "reason": "skipped_llm", "suggestion": ""}


def get_wp_hint(bloom_level: int, text: str, suggestion: str = "", lang: str = "ru") -> str:
    """ะะตะฝะตัะธััะตั ะฟะพะดัะบะฐะทะบั ะฟะพ ัะพัะผัะปะธัะพะฒะบะต ะะ ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั Bloom-ััะพะฒะฝั.

    Args:
        bloom_level: 1-3
        text: ะพัะธะณะธะฝะฐะปัะฝะฐั ัะพัะผัะปะธัะพะฒะบะฐ
        suggestion: ะฟัะตะดะปะพะถะตะฝะฝะพะต ะธัะฟัะฐะฒะปะตะฝะธะต (ะธะท LLM)
        lang: ัะทัะบ

    Returns:
        ะขะตะบัั ะฟะพะดัะบะฐะทะบะธ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั
    """
    bl = max(1, min(bloom_level, 3))
    example = suggestion or "ะงะตะบ-ะปะธัั ะฟัะธะฒััะตะบ"

    if lang != "ru":
        # ะะปั ะฝะต-ััััะบะธั ัะทัะบะพะฒ โ ัะฟัะพััะฝะฝะฐั ะฟะพะดัะบะฐะทะบะฐ
        return f"Next time, try naming the result (artifact). For example: *{example}*"

    if bl == 1:
        return (
            f"๐ก ะกะพะฒะตั: ะฒ ัะปะตะดัััะธะน ัะฐะท ะฟะพะฟัะพะฑัะน ะฝะฐะทะฒะฐัั *ัะตะทัะปััะฐั* โ "
            f"ัะพ, ััะพ ะฟะพะปััะธััั ะฒ ะธัะพะณะต. ะะฐะฟัะธะผะตั: *{example}*"
        )
    elif bl == 2:
        return (
            f"๐ก ะกะพะฒะตั: ัะฐะฑะพัะธะน ะฟัะพะดัะบั โ ััะพ *ะฐััะตัะฐะบั*, ะบะพัะพััะน ะผะพะถะฝะพ ะฟะพะบะฐะทะฐัั. "
            f"ะ ัะปะตะดัััะธะน ัะฐะท ะฟะพะฟัะพะฑัะน ะฝะฐะฟะธัะฐัั: *{example}*"
        )
    else:
        return (
            f"๐ก ะกะพะฒะตั: ะะ ัะพัะผัะปะธััะตััั ัััะตััะฒะธัะตะปัะฝัะผ (ัะตะทัะปััะฐั, ะฐ ะฝะต ะดะตะนััะฒะธะต). "
            f"ะ ัะปะตะดัััะธะน ัะฐะท ะฟะพะฟัะพะฑัะน: *{example}*"
        )
